{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/verfuegenListView/verfuegenListView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/verfuegenListView/verfuegenListView.ts","mtime":1518612532806},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["\"use strict\";\n/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar moment = require(\"moment\");\nvar TSAntragStatus_1 = require(\"../../../models/enums/TSAntragStatus\");\nvar TSBetreuungsstatus_1 = require(\"../../../models/enums/TSBetreuungsstatus\");\nvar TSFinSitStatus_1 = require(\"../../../models/enums/TSFinSitStatus\");\nvar TSMahnungTyp_1 = require(\"../../../models/enums/TSMahnungTyp\");\nvar TSRole_1 = require(\"../../../models/enums/TSRole\");\nvar TSWizardStepName_1 = require(\"../../../models/enums/TSWizardStepName\");\nvar TSWizardStepStatus_1 = require(\"../../../models/enums/TSWizardStepStatus\");\nvar TSMahnung_1 = require(\"../../../models/TSMahnung\");\nvar AuthenticationUtil_1 = require(\"../../../utils/AuthenticationUtil\");\nvar EbeguUtil_1 = require(\"../../../utils/EbeguUtil\");\nvar EnumEx_1 = require(\"../../../utils/EnumEx\");\nvar BemerkungenDialogController_1 = require(\"../../dialog/BemerkungenDialogController\");\nvar RemoveDialogController_1 = require(\"../../dialog/RemoveDialogController\");\nvar abstractGesuchView_1 = require(\"../abstractGesuchView\");\nvar template = require('./verfuegenListView.html');\nrequire('./verfuegenListView.less');\nvar removeDialogTempl = require('../../dialog/removeDialogTemplate.html');\nvar bemerkungDialogTempl = require('../../dialog/bemerkungenDialogTemplate.html');\nvar VerfuegenListViewComponentConfig = /** @class */ (function () {\n    function VerfuegenListViewComponentConfig() {\n        this.transclude = false;\n        this.bindings = {\n            // Bereits vorhandene Mahnungen\n            mahnungList: '<'\n        };\n        this.template = template;\n        this.controller = VerfuegenListViewController;\n        this.controllerAs = 'vm';\n    }\n    return VerfuegenListViewComponentConfig;\n}());\nexports.VerfuegenListViewComponentConfig = VerfuegenListViewComponentConfig;\nvar VerfuegenListViewController = /** @class */ (function (_super) {\n    __extends(VerfuegenListViewController, _super);\n    /* @ngInject */\n    function VerfuegenListViewController($state, gesuchModelManager, berechnungsManager, ebeguUtil, wizardStepManager, DvDialog, downloadRS, mahnungRS, $log, authServiceRs, $scope, gesuchRS, $timeout) {\n        var _this = _super.call(this, gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName_1.TSWizardStepName.VERFUEGEN, $timeout) || this;\n        _this.$state = $state;\n        _this.ebeguUtil = ebeguUtil;\n        _this.DvDialog = DvDialog;\n        _this.downloadRS = downloadRS;\n        _this.mahnungRS = mahnungRS;\n        _this.$log = $log;\n        _this.authServiceRs = authServiceRs;\n        _this.gesuchRS = gesuchRS;\n        _this.initViewModel();\n        return _this;\n    }\n    /**\n     * Die finanzielle Situation und die Einkommensverschlechterungen muessen mithilfe des Berechnungsmanagers\n     * berechnet werden, um manche Daten zur Verfügung zu haben. Das ist notwendig weil die finanzielle Situation nicht\n     * gespeichert wird. D.H. das erste Mal in einer Sitzung wenn ein Gesuch geoeffnet wird, ist gar nichts berechnet.\n     * Wenn man dann die Verfügen direkt aufmacht, ist alles leer und wird nichts angezeigt, deswegen muss alles auch\n     * hier berechnet werden. Um Probleme mit der Performance zu vermeiden, wird zuerst geprueft, ob die Berechnung\n     * schon vorher gemacht wurde, wenn ja dann wird sie einfach verwendet ohne sie neu berechnen zu muessen. Dieses\n     * geht aber davon aus, dass die Berechnungen immer richtig kalkuliert wurden.\n     *\n     * Die Verfuegungen werden IMMER geladen, wenn diese View geladen wird. Dieses ist etwas ineffizient. Allerdings\n     * muss es eigentlich so funktionieren, weil die Daten sich haben aendern koennen. Es ist ein aehnlicher Fall wie\n     * mit der finanziellen Situation. Sollte es Probleme mit der Performance geben, muessen wir ueberlegen, ob wir es\n     * irgendwie anders berechnen koennen um den Server zu entlasten.\n     */\n    VerfuegenListViewController.prototype.initViewModel = function () {\n        this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus_1.TSWizardStepStatus.WARTEN);\n        //Berechnung aller finanziellen Daten\n        if (!this.berechnungsManager.finanzielleSituationResultate) {\n            this.berechnungsManager.calculateFinanzielleSituation(this.gesuchModelManager.getGesuch()); //.then(() => {});\n        }\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().extractEinkommensverschlechterungInfo()\n            && this.gesuchModelManager.getGesuch().extractEinkommensverschlechterungInfo().ekvFuerBasisJahrPlus1\n            && !this.berechnungsManager.einkommensverschlechterungResultateBjP1) {\n            this.berechnungsManager.calculateEinkommensverschlechterung(this.gesuchModelManager.getGesuch(), 1); //.then(() => {});\n        }\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().extractEinkommensverschlechterungInfo()\n            && this.gesuchModelManager.getGesuch().extractEinkommensverschlechterungInfo().ekvFuerBasisJahrPlus2\n            && !this.berechnungsManager.einkommensverschlechterungResultateBjP2) {\n            this.berechnungsManager.calculateEinkommensverschlechterung(this.gesuchModelManager.getGesuch(), 2); //.then(() => {});\n        }\n        this.refreshKinderListe();\n        this.finSitStatus = EnumEx_1.EnumEx.getNames(TSFinSitStatus_1.TSFinSitStatus);\n    };\n    VerfuegenListViewController.prototype.refreshKinderListe = function () {\n        var _this = this;\n        return this.gesuchModelManager.calculateVerfuegungen().then(function () {\n            _this.kinderWithBetreuungList = _this.gesuchModelManager.getKinderWithBetreuungList();\n        });\n    };\n    VerfuegenListViewController.prototype.getKinderWithBetreuungList = function () {\n        return this.kinderWithBetreuungList;\n    };\n    VerfuegenListViewController.prototype.getMahnungList = function () {\n        return this.mahnungList;\n    };\n    /**\n     * Nur bestaetigte Betreuungen koennen geoeffnet werden\n     * @param kind\n     * @param betreuung\n     */\n    VerfuegenListViewController.prototype.openVerfuegung = function (kind, betreuung) {\n        if (this.kannVerfuegungOeffnen(betreuung)) {\n            if (kind && betreuung) {\n                var kindIndex = this.gesuchModelManager.convertKindNumberToKindIndex(kind.kindNummer);\n                if (kindIndex >= 0) {\n                    this.gesuchModelManager.setKindIndex(kindIndex);\n                    this.$state.go('gesuch.verfuegenView', {\n                        betreuungNumber: betreuung.betreuungNummer,\n                        kindNumber: kind.kindNummer,\n                        gesuchId: this.getGesuchId()\n                    });\n                }\n            }\n        }\n    };\n    VerfuegenListViewController.prototype.kannVerfuegungOeffnen = function (betreuung) {\n        return this.isDetailAvailableForGesuchstatus() && this.isDetailAvailableForBetreuungstatus(betreuung.betreuungsstatus);\n    };\n    VerfuegenListViewController.prototype.isDetailAvailableForGesuchstatus = function () {\n        var isGesuchsteller = this.authServiceRs.isRole(TSRole_1.TSRole.GESUCHSTELLER);\n        //gesuchsteller hat sicher mal nur Zugriff auf verfuegungsdetail wenn das gesuch mindestens freiggeben ist\n        if (isGesuchsteller) {\n            var status = this.getGesuch() ? this.getGesuch().status : TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_GS;\n            return TSAntragStatus_1.isAtLeastFreigegeben(status);\n        }\n        else {\n            return true;\n        }\n    };\n    VerfuegenListViewController.prototype.isDetailAvailableForBetreuungstatus = function (betreuungsstatus) {\n        var isGesuchsteller = this.authServiceRs.isRole(TSRole_1.TSRole.GESUCHSTELLER);\n        var allowedBetstatus = [TSBetreuungsstatus_1.TSBetreuungsstatus.VERFUEGT, TSBetreuungsstatus_1.TSBetreuungsstatus.NICHT_EINGETRETEN, TSBetreuungsstatus_1.TSBetreuungsstatus.STORNIERT];\n        //Annahme: alle ausser Gesuchsteller duerfen bestaetigte betreuungen sehen wenn sie uberhaupt auf die Seite kommen\n        if (!isGesuchsteller) {\n            allowedBetstatus.push(TSBetreuungsstatus_1.TSBetreuungsstatus.BESTAETIGT);\n        }\n        return allowedBetstatus.indexOf(betreuungsstatus) !== -1;\n    };\n    /**\n     * das FinanzielleSituation PDF ist fuer den Gesuchsteller erst sichtbar sobald der Antrag den Status VERFUEGT\n     * erreicht hat\n     */\n    VerfuegenListViewController.prototype.isFinanziellesituationPDFVisible = function () {\n        if (!this.gesuchModelManager.isFinanzielleSituationEnabled() || !this.gesuchModelManager.isFinanzielleSituationDesired()) {\n            return false;\n        }\n        var isGesuchsteller = this.authServiceRs.isRole(TSRole_1.TSRole.GESUCHSTELLER);\n        if (isGesuchsteller) {\n            var status = this.getGesuch() ? this.getGesuch().status : TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_GS;\n            return TSAntragStatus_1.isAnyStatusOfVerfuegt(status) && this.getGesuch().hasFSDokument && !this.isFinSitAbglehnt();\n        }\n        return this.getGesuch().hasFSDokument && !this.isFinSitAbglehnt();\n    };\n    VerfuegenListViewController.prototype.isFinanzielleSituationDesired = function () {\n        return this.gesuchModelManager.isFinanzielleSituationDesired();\n    };\n    VerfuegenListViewController.prototype.isBegleitschreibenVisible = function () {\n        var isGesuchsteller = this.authServiceRs.isRole(TSRole_1.TSRole.GESUCHSTELLER);\n        if (isGesuchsteller) {\n            var status = this.getGesuch() ? this.getGesuch().status : TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_GS;\n            return TSAntragStatus_1.isAnyStatusOfVerfuegt(status) && !this.gesuchModelManager.areThereOnlySchulamtAngebote() && !this.gesuchModelManager.areThereOnlyGeschlossenOhneVerfuegung();\n        }\n        return !this.gesuchModelManager.areThereOnlySchulamtAngebote() && !this.gesuchModelManager.areThereOnlyGeschlossenOhneVerfuegung();\n    };\n    VerfuegenListViewController.prototype.getFall = function () {\n        if (this.gesuchModelManager && this.gesuchModelManager.getGesuch()) {\n            return this.gesuchModelManager.getGesuch().fall;\n        }\n        return undefined;\n    };\n    VerfuegenListViewController.prototype.getGesuch = function () {\n        if (this.gesuchModelManager && this.gesuchModelManager.getGesuch()) {\n            return this.gesuchModelManager.getGesuch();\n        }\n        return undefined;\n    };\n    VerfuegenListViewController.prototype.getGesuchsperiode = function () {\n        if (this.gesuchModelManager) {\n            return this.gesuchModelManager.getGesuchsperiode();\n        }\n        return undefined;\n    };\n    VerfuegenListViewController.prototype.setGesuchStatusGeprueft = function () {\n        var _this = this;\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController_1.RemoveDialogController, {\n            title: 'CONFIRM_GESUCH_STATUS_GEPRUEFT',\n            deleteText: 'BESCHREIBUNG_GESUCH_STATUS_WECHSELN',\n            parentController: undefined,\n            elementID: undefined\n        }).then(function () {\n            return _this.setGesuchStatus(TSAntragStatus_1.TSAntragStatus.GEPRUEFT);\n        });\n    };\n    VerfuegenListViewController.prototype.closeWithoutAngebot = function () {\n        var _this = this;\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController_1.RemoveDialogController, {\n            title: 'CONFIRM_GESUCH_STATUS_KEIN_ANGEBOT',\n            deleteText: 'BESCHREIBUNG_GESUCH_STATUS_WECHSELN',\n            parentController: undefined,\n            elementID: undefined\n        }).then(function () {\n            return _this.gesuchRS.closeWithoutAngebot(_this.gesuchModelManager.getGesuch().id).then(function (response) {\n                _this.gesuchModelManager.setGesuch(response);\n                _this.form.$setPristine(); // nach dem es gespeichert wird, muessen wir das Form wieder auf clean setzen\n                return _this.refreshKinderListe().then(function () {\n                    return _this.gesuchModelManager.getGesuch();\n                });\n            });\n        });\n    };\n    VerfuegenListViewController.prototype.setGesuchStatusVerfuegen = function () {\n        var _this = this;\n        var deleteTextValue = 'BESCHREIBUNG_GESUCH_STATUS_WECHSELN';\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController_1.RemoveDialogController, {\n            title: 'CONFIRM_GESUCH_STATUS_VERFUEGEN',\n            deleteText: deleteTextValue,\n            parentController: undefined,\n            elementID: undefined\n        }).then(function () {\n            return _this.gesuchRS.verfuegenStarten(_this.gesuchModelManager.getGesuch().id, _this.gesuchModelManager.getGesuch().hasFSDokument).then(function (response) {\n                if (response.status === TSAntragStatus_1.TSAntragStatus.NUR_SCHULAMT) {\n                    // If AntragStatus==NUR_SCHULAMT the Sachbearbeiter_JA has no rights to work with or even to see this gesuch any more\n                    // For this reason we have to navigate directly out of the gesuch once it has been saved. We navigate to the\n                    // default start page for the current role.\n                    // createNeededPDFs is not being called for the same reason. Anyway, the Gesuch vanishes for the role JA and is only\n                    // available for the role SCHULAMT/ADMINISTRATOR_SCHULAMT, so JA doesn't need the PDFs to be created. When a Schulamt worker opens this\n                    // Gesuch, she can generate the PDFs by clicking on the corresponding links\n                    AuthenticationUtil_1.default.navigateToStartPageForRole(_this.authServiceRs.getPrincipal(), _this.$state);\n                    return _this.gesuchModelManager.getGesuch();\n                }\n                else {\n                    _this.gesuchModelManager.setGesuch(response);\n                    _this.form.$setPristine(); // nach dem es gespeichert wird, muessen wir das Form wieder auf clean setzen\n                    return _this.refreshKinderListe().then(function () {\n                        return _this.gesuchModelManager.getGesuch();\n                    });\n                }\n            });\n        });\n    };\n    VerfuegenListViewController.prototype.hasOffeneMahnungen = function () {\n        for (var _i = 0, _a = this.mahnungList; _i < _a.length; _i++) {\n            var mahn = _a[_i];\n            if (!mahn.timestampAbgeschlossen) {\n                return true;\n            }\n        }\n        return false;\n    };\n    VerfuegenListViewController.prototype.sendToSteuerverwaltung = function () {\n        var _this = this;\n        this.DvDialog.showDialog(bemerkungDialogTempl, BemerkungenDialogController_1.BemerkungenDialogController, {\n            title: 'SEND_TO_STV_CONFIRMATION',\n            bemerkungen: this.gesuchModelManager.getGesuch().bemerkungenSTV\n        }).then(function (bemerkung) {\n            _this.gesuchRS.sendGesuchToSTV(_this.getGesuch().id, bemerkung).then(function (gesuch) {\n                _this.gesuchModelManager.setGesuch(gesuch);\n            });\n        });\n    };\n    VerfuegenListViewController.prototype.showSendToSteuerverwaltung = function () {\n        //hier wird extra nur \"VERFUEGT\" gestestet statt alle verfuegten status weil das Schulamt das Gesuch nicht pruefen lassen darf\n        return (this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.VERFUEGT) || this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.NUR_SCHULAMT))\n            && !this.getGesuch().gesperrtWegenBeschwerde;\n    };\n    VerfuegenListViewController.prototype.stvPruefungAbschliessen = function () {\n        var _this = this;\n        this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController_1.RemoveDialogController, {\n            title: 'STV_PRUEFUNG_ABSCHLIESSEN_CONFIRMATION',\n            deleteText: '',\n            parentController: undefined,\n            elementID: undefined\n        }).then(function (bemerkung) {\n            _this.gesuchRS.stvPruefungAbschliessen(_this.getGesuch().id).then(function (gesuch) {\n                _this.gesuchModelManager.setGesuch(gesuch);\n            });\n        });\n    };\n    VerfuegenListViewController.prototype.showSTVPruefungAbschliessen = function () {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.GEPRUEFT_STV) && !this.getGesuch().gesperrtWegenBeschwerde;\n    };\n    VerfuegenListViewController.prototype.showErsteMahnungErstellen = function () {\n        // Nur wenn keine offenen Mahnungen vorhanden!\n        return (this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_JA) || this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.FREIGEGEBEN))\n            && this.mahnung === undefined && !this.hasOffeneMahnungen() && !this.isGesuchReadonly();\n    };\n    VerfuegenListViewController.prototype.showErsteMahnungAusloesen = function () {\n        return this.mahnung !== undefined && this.mahnung.mahnungTyp === TSMahnungTyp_1.TSMahnungTyp.ERSTE_MAHNUNG\n            && !this.isGesuchReadonly();\n    };\n    VerfuegenListViewController.prototype.showZweiteMahnungErstellen = function () {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.ERSTE_MAHNUNG_ABGELAUFEN)\n            && this.mahnung === undefined && !this.isGesuchReadonly();\n    };\n    VerfuegenListViewController.prototype.showZweiteMahnungAusloesen = function () {\n        return this.mahnung !== undefined && this.mahnung.mahnungTyp === TSMahnungTyp_1.TSMahnungTyp.ZWEITE_MAHNUNG\n            && !this.isGesuchReadonly();\n    };\n    /**\n     * Nur required in Status VERFUEGEN oder GEPRUEFT und wenn der Benutzer nicht am Erstellen einer Mahnung ist.\n     */\n    VerfuegenListViewController.prototype.isFinSitStatusRequired = function () {\n        return !this.showErsteMahnungAusloesen() && !this.showZweiteMahnungAusloesen()\n            && (this.getGesuch().status === TSAntragStatus_1.TSAntragStatus.VERFUEGEN || this.getGesuch().status === TSAntragStatus_1.TSAntragStatus.GEPRUEFT);\n    };\n    VerfuegenListViewController.prototype.showMahnlaufBeenden = function () {\n        return TSAntragStatus_1.isAnyStatusOfMahnung(this.getGesuch().status) && !this.isGesuchReadonly();\n    };\n    VerfuegenListViewController.prototype.showDokumenteNichtKomplett = function () {\n        return TSAntragStatus_1.isAnyStatusOfMahnung(this.getGesuch().status) && this.getGesuch().dokumenteHochgeladen\n            && !this.isGesuchReadonly();\n    };\n    VerfuegenListViewController.prototype.showZweiteMahnungNichtEingetreten = function () {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.ZWEITE_MAHNUNG_ABGELAUFEN) && !this.isGesuchReadonly();\n    };\n    VerfuegenListViewController.prototype.ersteMahnungErstellen = function () {\n        this.tempAntragStatus = TSAntragStatus_1.TSAntragStatus.ERSTE_MAHNUNG;\n        this.createMahnung(TSMahnungTyp_1.TSMahnungTyp.ERSTE_MAHNUNG);\n    };\n    VerfuegenListViewController.prototype.zweiteMahnungErstellen = function () {\n        this.tempAntragStatus = TSAntragStatus_1.TSAntragStatus.ZWEITE_MAHNUNG;\n        this.createMahnung(TSMahnungTyp_1.TSMahnungTyp.ZWEITE_MAHNUNG);\n    };\n    VerfuegenListViewController.prototype.saveMahnung = function () {\n        var _this = this;\n        if (this.form.$valid) {\n            this.mahnungRS.saveMahnung(this.mahnung).then(function (mahnungResponse) {\n                _this.setGesuchStatus(_this.tempAntragStatus).then(function (any) {\n                    _this.mahnungList.push(mahnungResponse);\n                    _this.tempAntragStatus = undefined;\n                    _this.mahnung = undefined;\n                });\n            });\n        }\n    };\n    VerfuegenListViewController.prototype.createMahnung = function (typ) {\n        var _this = this;\n        return this.mahnungRS.getInitialeBemerkungen(this.getGesuch()).then(function (generatedBemerkungen) {\n            _this.mahnung = new TSMahnung_1.default();\n            _this.mahnung.mahnungTyp = typ;\n            _this.mahnung.gesuch = _this.getGesuch();\n            _this.mahnung.timestampAbgeschlossen = null;\n            _this.mahnung.bemerkungen = generatedBemerkungen.data;\n            if (_this.getGesuchsperiode().hasTagesschulenAnmeldung() && _this.getGesuch().areThereOnlySchulamtAngebote()) {\n                _this.mahnung.datumFristablauf = moment(moment.now()).add(7, 'days');\n            }\n            return;\n        });\n    };\n    VerfuegenListViewController.prototype.mahnlaufBeenden = function () {\n        var _this = this;\n        // Gesuchstatus zuruecksetzen UND die Mahnungen auf erledigt setzen\n        this.mahnungRS.mahnlaufBeenden(this.getGesuch()).then(function (gesuch) {\n            _this.mahnungRS.findMahnungen(_this.getGesuch().id).then(function (reloadedMahnungen) {\n                _this.mahnungList = reloadedMahnungen;\n                _this.gesuchModelManager.getGesuch().status = TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_JA;\n            });\n        });\n    };\n    VerfuegenListViewController.prototype.dokumenteNichtKomplett = function () {\n        this.gesuchModelManager.getGesuch().dokumenteHochgeladen = false;\n        this.gesuchModelManager.updateGesuch();\n    };\n    VerfuegenListViewController.prototype.zweiteMahnungNichtEingetreten = function () {\n        // Auf die zweite Mahnung wurde nicht reagiert. Den Status des Gesuchs wieder auf IN_BEARBEITUNG setzen\n        // damit die Betreuungen auf NICHT_EINGETRETEN verfügt werden können. Die Mahnungen bleiben aber offen!\n        this.setGesuchStatus(TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_JA);\n    };\n    /**\n     * Der Button Geprueft wird nur beim Status IN_BEARBEITUNG_JA eingeblendet\n     * @returns {boolean}\n     */\n    VerfuegenListViewController.prototype.showGeprueft = function () {\n        return (this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_JA) || this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.FREIGEGEBEN))\n            && this.wizardStepManager.areAllStepsOK(this.getGesuch()) && this.mahnung === undefined\n            && !this.gesuchModelManager.areThereOnlySchulamtAngebote()\n            && !this.isGesuchReadonly();\n    };\n    /**\n     * Der Button Verfuegung starten wird angezeigt, wenn alle Betreuungen bestaetigt und das Gesuch geprueft wurden\n     * @returns {boolean}\n     */\n    VerfuegenListViewController.prototype.showVerfuegenStarten = function () {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.GEPRUEFT)\n            && this.wizardStepManager.isStepStatusOk(TSWizardStepName_1.TSWizardStepName.BETREUUNG)\n            && this.gesuchModelManager.getGesuch().isThereAnyBetreuung()\n            && !this.gesuchModelManager.areThereOnlySchulamtAngebote()\n            && !this.isGesuchReadonly();\n        // && this.gesuchModelManager.getGesuch().status !== TSAntragStatus.VERFUEGEN;\n    };\n    /**\n     * Nur wenn ein Gesuch keine Angebote hat und geprueft ist, kann man es ohne Angebote schliessen.\n     */\n    VerfuegenListViewController.prototype.showCloseWithoutAngebot = function () {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus_1.TSAntragStatus.GEPRUEFT)\n            && !this.gesuchModelManager.getGesuch().isThereAnyBetreuung()\n            && !this.isGesuchReadonly();\n    };\n    /**\n     * ausblenden, wenn Gesuch readonly und finSitStatus nicht gesetzt (für alte Gesuche). Fuer GS nicht anzeigen.\n     */\n    VerfuegenListViewController.prototype.showFinSitStatus = function () {\n        return !(this.isGesuchReadonly() && EbeguUtil_1.default.isNullOrUndefined(this.getGesuch().finSitStatus))\n            && this.authServiceRs.isOneOfRoles(this.TSRoleUtil.getJugendamtAndSchulamtRole());\n    };\n    VerfuegenListViewController.prototype.openFinanzielleSituationPDF = function () {\n        var _this = this;\n        var win = this.downloadRS.prepareDownloadWindow();\n        this.downloadRS.getFinSitDokumentAccessTokenGeneratedDokument(this.gesuchModelManager.getGesuch().id)\n            .then(function (downloadFile) {\n            _this.$log.debug('accessToken: ' + downloadFile.accessToken);\n            _this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n        })\n            .catch(function (ex) {\n            win.close();\n            _this.$log.error('An error occurred downloading the document, closing download window.');\n        });\n    };\n    VerfuegenListViewController.prototype.openBegleitschreibenPDF = function () {\n        var _this = this;\n        var win = this.downloadRS.prepareDownloadWindow();\n        this.downloadRS.getBegleitschreibenDokumentAccessTokenGeneratedDokument(this.gesuchModelManager.getGesuch().id, false)\n            .then(function (downloadFile) {\n            _this.$log.debug('accessToken: ' + downloadFile.accessToken);\n            _this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n        })\n            .catch(function (ex) {\n            win.close();\n            _this.$log.error('An error occurred downloading the document, closing download window.');\n        });\n    };\n    VerfuegenListViewController.prototype.openMahnungPDF = function (mahnung) {\n        var _this = this;\n        var win = this.downloadRS.prepareDownloadWindow();\n        if (mahnung == null) {\n            mahnung = this.mahnung;\n        }\n        this.downloadRS.getAccessTokenMahnungGeneratedDokument(mahnung)\n            .then(function (downloadFile) {\n            _this.$log.debug('accessToken: ' + downloadFile.accessToken);\n            _this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n        })\n            .catch(function (ex) {\n            win.close();\n            _this.$log.error('An error occurred downloading the document, closing download window.');\n        });\n    };\n    VerfuegenListViewController.prototype.showBeschwerdeHaengig = function () {\n        var status = this.getGesuch() ? this.getGesuch().status : TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_GS;\n        // Schulamt Status duerfen keine Beschwerde starten\n        return TSAntragStatus_1.isAnyStatusOfVerfuegt(status) && !this.getGesuch().gesperrtWegenBeschwerde;\n    };\n    VerfuegenListViewController.prototype.showBeschwerdeAbschliessen = function () {\n        var status = this.getGesuch() ? this.getGesuch().status : TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_GS;\n        return TSAntragStatus_1.TSAntragStatus.BESCHWERDE_HAENGIG === status;\n    };\n    VerfuegenListViewController.prototype.showAbschliessen = function () {\n        var status = this.getGesuch() ? this.getGesuch().status : TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_GS;\n        return (TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_JA === status || TSAntragStatus_1.TSAntragStatus.GEPRUEFT === status)\n            && this.gesuchModelManager.areThereOnlySchulamtAngebote();\n    };\n    VerfuegenListViewController.prototype.isFinSitChoosen = function () {\n        if (this.getGesuch() && this.getGesuch().finSitStatus) {\n            return true;\n        }\n        return false;\n    };\n    VerfuegenListViewController.prototype.isFinSitAbglehnt = function () {\n        if (this.isFinSitChoosen() && this.getGesuch().finSitStatus !== TSFinSitStatus_1.TSFinSitStatus.AKZEPTIERT) {\n            return true;\n        }\n        return false;\n    };\n    VerfuegenListViewController.prototype.setAbschliessen = function () {\n        var _this = this;\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController_1.RemoveDialogController, {\n            title: 'ABSCHLIESSEN',\n            deleteText: 'BESCHREIBUNG_GESUCH_ABSCHLIESSEN',\n            parentController: undefined,\n            elementID: undefined\n        }).then(function () {\n            return _this.gesuchRS.setAbschliessen(_this.getGesuch().id).then(function (gesuch) {\n                _this.gesuchModelManager.setGesuch(gesuch);\n                return _this.gesuchModelManager.getGesuch();\n            });\n        });\n    };\n    VerfuegenListViewController.prototype.setGesuchStatusBeschwerdeHaengig = function () {\n        var _this = this;\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController_1.RemoveDialogController, {\n            title: 'BESCHWERDE_HAENGIG',\n            deleteText: 'BESCHREIBUNG_GESUCH_BESCHWERDE_HAENGIG',\n            parentController: undefined,\n            elementID: undefined\n        }).then(function () {\n            return _this.gesuchRS.setBeschwerdeHaengig(_this.getGesuch().id).then(function (gesuch) {\n                _this.gesuchModelManager.setGesuch(gesuch);\n                return _this.gesuchModelManager.getGesuch();\n            });\n        });\n    };\n    VerfuegenListViewController.prototype.setGesuchStatusBeschwerdeAbschliessen = function () {\n        var _this = this;\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController_1.RemoveDialogController, {\n            title: 'BESCHWERDE_ABSCHLIESSEN',\n            deleteText: 'BESCHREIBUNG_GESUCH_BESCHWERDE_ABSCHLIESSEN',\n            parentController: undefined,\n            elementID: undefined\n        }).then(function () {\n            return _this.gesuchRS.removeBeschwerdeHaengig(_this.getGesuch().id).then(function (gesuch) {\n                _this.gesuchModelManager.setGesuch(gesuch);\n                return _this.gesuchModelManager.getGesuch();\n            });\n        });\n    };\n    VerfuegenListViewController.prototype.changeFinSitStatus = function () {\n        var _this = this;\n        if (this.getGesuch().finSitStatus) {\n            this.setHasFSDokumentAccordingToFinSitState();\n            this.gesuchRS.changeFinSitStatus(this.getGesuch().id, this.getGesuch().finSitStatus).then(function (response) {\n                _this.gesuchModelManager.setGesuch(_this.getGesuch());\n                _this.form.$setPristine();\n            });\n        }\n    };\n    VerfuegenListViewController.prototype.setHasFSDokumentAccordingToFinSitState = function () {\n        if (this.isFinSitAbglehnt()) {\n            this.getGesuch().hasFSDokument = false;\n        }\n        else {\n            this.getGesuch().hasFSDokument = true;\n        }\n    };\n    VerfuegenListViewController.prototype.fsDokumentChanged = function () {\n        // dirty checker wird hier ausgeschaltet. Aenderungen des fs flag wird automatisch gespeichert wenn gesuch auf geprüft gesetzt wird\n        // Aus performance Gründen wird hier daruf verzichtet das Gesuch neu zu persisten, nur weil das Flag ändert.\n        this.form.$setPristine();\n    };\n    VerfuegenListViewController.prototype.isSuperAdmin = function () {\n        return this.authServiceRs.isRole(TSRole_1.TSRole.SUPER_ADMIN);\n    };\n    VerfuegenListViewController.prototype.$postLink = function () {\n        this.$timeout(function () {\n            EbeguUtil_1.default.selectFirst();\n        }, 500);\n    };\n    VerfuegenListViewController.$inject = ['$state', 'GesuchModelManager', 'BerechnungsManager', 'EbeguUtil', 'WizardStepManager',\n        'DvDialog', 'DownloadRS', 'MahnungRS', '$log', 'AuthServiceRS', '$scope', 'GesuchRS', '$timeout'];\n    return VerfuegenListViewController;\n}(abstractGesuchView_1.default));\nexports.VerfuegenListViewController = VerfuegenListViewController;\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/verfuegenListView/verfuegenListView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/verfuegenListView/verfuegenListView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {IComponentOptions, ILogService, IPromise, IScope} from 'angular';\nimport {IStateService} from 'angular-ui-router';\nimport * as moment from 'moment';\nimport AuthServiceRS from '../../../authentication/service/AuthServiceRS.rest';\nimport {DvDialog} from '../../../core/directive/dv-dialog/dv-dialog';\nimport {DownloadRS} from '../../../core/service/downloadRS.rest';\nimport {isAnyStatusOfMahnung, isAnyStatusOfVerfuegt, isAtLeastFreigegeben, TSAntragStatus} from '../../../models/enums/TSAntragStatus';\nimport {TSBetreuungsstatus} from '../../../models/enums/TSBetreuungsstatus';\nimport {TSFinSitStatus} from '../../../models/enums/TSFinSitStatus';\nimport {TSMahnungTyp} from '../../../models/enums/TSMahnungTyp';\nimport {TSRole} from '../../../models/enums/TSRole';\nimport {TSWizardStepName} from '../../../models/enums/TSWizardStepName';\nimport {TSWizardStepStatus} from '../../../models/enums/TSWizardStepStatus';\nimport TSBetreuung from '../../../models/TSBetreuung';\nimport TSDownloadFile from '../../../models/TSDownloadFile';\nimport TSGesuch from '../../../models/TSGesuch';\nimport TSGesuchsperiode from '../../../models/TSGesuchsperiode';\nimport TSKindContainer from '../../../models/TSKindContainer';\nimport TSMahnung from '../../../models/TSMahnung';\nimport AuthenticationUtil from '../../../utils/AuthenticationUtil';\nimport EbeguUtil from '../../../utils/EbeguUtil';\nimport {EnumEx} from '../../../utils/EnumEx';\nimport {BemerkungenDialogController} from '../../dialog/BemerkungenDialogController';\nimport {RemoveDialogController} from '../../dialog/RemoveDialogController';\nimport BerechnungsManager from '../../service/berechnungsManager';\nimport GesuchModelManager from '../../service/gesuchModelManager';\nimport GesuchRS from '../../service/gesuchRS.rest';\nimport MahnungRS from '../../service/mahnungRS.rest';\nimport WizardStepManager from '../../service/wizardStepManager';\nimport AbstractGesuchViewController from '../abstractGesuchView';\nimport ITimeoutService = angular.ITimeoutService;\n\nlet template = require('./verfuegenListView.html');\nrequire('./verfuegenListView.less');\nlet removeDialogTempl = require('../../dialog/removeDialogTemplate.html');\nlet bemerkungDialogTempl = require('../../dialog/bemerkungenDialogTemplate.html');\n\nexport class VerfuegenListViewComponentConfig implements IComponentOptions {\n    transclude = false;\n    bindings: any = {\n        // Bereits vorhandene Mahnungen\n        mahnungList: '<'\n    };\n    template = template;\n    controller = VerfuegenListViewController;\n    controllerAs = 'vm';\n}\n\nexport class VerfuegenListViewController extends AbstractGesuchViewController<any> {\n\n    private kinderWithBetreuungList: Array<TSKindContainer>;\n    mahnungList: TSMahnung[];\n    private mahnung: TSMahnung;\n    private tempAntragStatus: TSAntragStatus;\n    finSitStatus: Array<string>;\n\n    static $inject: string[] = ['$state', 'GesuchModelManager', 'BerechnungsManager', 'EbeguUtil', 'WizardStepManager',\n        'DvDialog', 'DownloadRS', 'MahnungRS', '$log', 'AuthServiceRS', '$scope', 'GesuchRS', '$timeout'];\n\n    /* @ngInject */\n\n    constructor(private $state: IStateService, gesuchModelManager: GesuchModelManager, berechnungsManager: BerechnungsManager,\n                private ebeguUtil: EbeguUtil, wizardStepManager: WizardStepManager, private DvDialog: DvDialog,\n                private downloadRS: DownloadRS, private mahnungRS: MahnungRS, private $log: ILogService,\n                private authServiceRs: AuthServiceRS, $scope: IScope, private gesuchRS: GesuchRS,\n                $timeout: ITimeoutService) {\n\n        super(gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName.VERFUEGEN, $timeout);\n        this.initViewModel();\n    }\n\n    /**\n     * Die finanzielle Situation und die Einkommensverschlechterungen muessen mithilfe des Berechnungsmanagers\n     * berechnet werden, um manche Daten zur Verfügung zu haben. Das ist notwendig weil die finanzielle Situation nicht\n     * gespeichert wird. D.H. das erste Mal in einer Sitzung wenn ein Gesuch geoeffnet wird, ist gar nichts berechnet.\n     * Wenn man dann die Verfügen direkt aufmacht, ist alles leer und wird nichts angezeigt, deswegen muss alles auch\n     * hier berechnet werden. Um Probleme mit der Performance zu vermeiden, wird zuerst geprueft, ob die Berechnung\n     * schon vorher gemacht wurde, wenn ja dann wird sie einfach verwendet ohne sie neu berechnen zu muessen. Dieses\n     * geht aber davon aus, dass die Berechnungen immer richtig kalkuliert wurden.\n     *\n     * Die Verfuegungen werden IMMER geladen, wenn diese View geladen wird. Dieses ist etwas ineffizient. Allerdings\n     * muss es eigentlich so funktionieren, weil die Daten sich haben aendern koennen. Es ist ein aehnlicher Fall wie\n     * mit der finanziellen Situation. Sollte es Probleme mit der Performance geben, muessen wir ueberlegen, ob wir es\n     * irgendwie anders berechnen koennen um den Server zu entlasten.\n     */\n    private initViewModel(): void {\n        this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus.WARTEN);\n\n        //Berechnung aller finanziellen Daten\n        if (!this.berechnungsManager.finanzielleSituationResultate) {\n            this.berechnungsManager.calculateFinanzielleSituation(this.gesuchModelManager.getGesuch()); //.then(() => {});\n        }\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().extractEinkommensverschlechterungInfo()\n            && this.gesuchModelManager.getGesuch().extractEinkommensverschlechterungInfo().ekvFuerBasisJahrPlus1\n            && !this.berechnungsManager.einkommensverschlechterungResultateBjP1) {\n\n            this.berechnungsManager.calculateEinkommensverschlechterung(this.gesuchModelManager.getGesuch(), 1); //.then(() => {});\n        }\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().extractEinkommensverschlechterungInfo()\n            && this.gesuchModelManager.getGesuch().extractEinkommensverschlechterungInfo().ekvFuerBasisJahrPlus2\n            && !this.berechnungsManager.einkommensverschlechterungResultateBjP2) {\n\n            this.berechnungsManager.calculateEinkommensverschlechterung(this.gesuchModelManager.getGesuch(), 2); //.then(() => {});\n        }\n        this.refreshKinderListe();\n        this.finSitStatus = EnumEx.getNames(TSFinSitStatus);\n    }\n\n    private refreshKinderListe(): IPromise<any> {\n        return this.gesuchModelManager.calculateVerfuegungen().then(() => {\n            this.kinderWithBetreuungList = this.gesuchModelManager.getKinderWithBetreuungList();\n        });\n    }\n\n    public getKinderWithBetreuungList(): Array<TSKindContainer> {\n        return this.kinderWithBetreuungList;\n    }\n\n    public getMahnungList(): Array<TSMahnung> {\n        return this.mahnungList;\n    }\n\n    /**\n     * Nur bestaetigte Betreuungen koennen geoeffnet werden\n     * @param kind\n     * @param betreuung\n     */\n    public openVerfuegung(kind: TSKindContainer, betreuung: TSBetreuung): void {\n        if (this.kannVerfuegungOeffnen(betreuung)) {\n            if (kind && betreuung) {\n                let kindIndex: number = this.gesuchModelManager.convertKindNumberToKindIndex(kind.kindNummer);\n                if (kindIndex >= 0) {\n                    this.gesuchModelManager.setKindIndex(kindIndex);\n                    this.$state.go('gesuch.verfuegenView', {\n                        betreuungNumber: betreuung.betreuungNummer,\n                        kindNumber: kind.kindNummer,\n                        gesuchId: this.getGesuchId()\n                    });\n                }\n            }\n        }\n    }\n\n    public kannVerfuegungOeffnen(betreuung: TSBetreuung): boolean {\n        return this.isDetailAvailableForGesuchstatus() && this.isDetailAvailableForBetreuungstatus(betreuung.betreuungsstatus);\n    }\n\n    private isDetailAvailableForGesuchstatus(): boolean {\n        let isGesuchsteller: boolean = this.authServiceRs.isRole(TSRole.GESUCHSTELLER);\n        //gesuchsteller hat sicher mal nur Zugriff auf verfuegungsdetail wenn das gesuch mindestens freiggeben ist\n        if (isGesuchsteller) {\n            let status: TSAntragStatus = this.getGesuch() ? this.getGesuch().status : TSAntragStatus.IN_BEARBEITUNG_GS;\n            return isAtLeastFreigegeben(status);\n        } else {\n            return true;\n        }\n    }\n\n    private isDetailAvailableForBetreuungstatus(betreuungsstatus: TSBetreuungsstatus): boolean {\n        let isGesuchsteller: boolean = this.authServiceRs.isRole(TSRole.GESUCHSTELLER);\n        let allowedBetstatus: Array<TSBetreuungsstatus> = [TSBetreuungsstatus.VERFUEGT, TSBetreuungsstatus.NICHT_EINGETRETEN, TSBetreuungsstatus.STORNIERT];\n        //Annahme: alle ausser Gesuchsteller duerfen bestaetigte betreuungen sehen wenn sie uberhaupt auf die Seite kommen\n        if (!isGesuchsteller) {\n            allowedBetstatus.push(TSBetreuungsstatus.BESTAETIGT);\n        }\n        return allowedBetstatus.indexOf(betreuungsstatus) !== -1;\n    }\n\n    /**\n     * das FinanzielleSituation PDF ist fuer den Gesuchsteller erst sichtbar sobald der Antrag den Status VERFUEGT\n     * erreicht hat\n     */\n    public isFinanziellesituationPDFVisible(): boolean {\n        if (!this.gesuchModelManager.isFinanzielleSituationEnabled() || !this.gesuchModelManager.isFinanzielleSituationDesired()) {\n            return false;\n        }\n        let isGesuchsteller: boolean = this.authServiceRs.isRole(TSRole.GESUCHSTELLER);\n        if (isGesuchsteller) {\n            let status: TSAntragStatus = this.getGesuch() ? this.getGesuch().status : TSAntragStatus.IN_BEARBEITUNG_GS;\n            return isAnyStatusOfVerfuegt(status) && this.getGesuch().hasFSDokument && !this.isFinSitAbglehnt();\n        }\n        return this.getGesuch().hasFSDokument && !this.isFinSitAbglehnt();\n\n    }\n\n    public isFinanzielleSituationDesired(): boolean {\n        return this.gesuchModelManager.isFinanzielleSituationDesired();\n    }\n\n    public isBegleitschreibenVisible(): boolean {\n        let isGesuchsteller: boolean = this.authServiceRs.isRole(TSRole.GESUCHSTELLER);\n        if (isGesuchsteller) {\n            let status: TSAntragStatus = this.getGesuch() ? this.getGesuch().status : TSAntragStatus.IN_BEARBEITUNG_GS;\n            return isAnyStatusOfVerfuegt(status) && !this.gesuchModelManager.areThereOnlySchulamtAngebote() && !this.gesuchModelManager.areThereOnlyGeschlossenOhneVerfuegung();\n        }\n        return !this.gesuchModelManager.areThereOnlySchulamtAngebote() && !this.gesuchModelManager.areThereOnlyGeschlossenOhneVerfuegung();\n    }\n\n    public getFall() {\n        if (this.gesuchModelManager && this.gesuchModelManager.getGesuch()) {\n            return this.gesuchModelManager.getGesuch().fall;\n        }\n        return undefined;\n    }\n\n    public getGesuch(): TSGesuch {\n        if (this.gesuchModelManager && this.gesuchModelManager.getGesuch()) {\n            return this.gesuchModelManager.getGesuch();\n        }\n        return undefined;\n    }\n\n    public getGesuchsperiode(): TSGesuchsperiode {\n        if (this.gesuchModelManager) {\n            return this.gesuchModelManager.getGesuchsperiode();\n        }\n        return undefined;\n    }\n\n    public setGesuchStatusGeprueft(): IPromise<TSAntragStatus> {\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController, {\n            title: 'CONFIRM_GESUCH_STATUS_GEPRUEFT',\n            deleteText: 'BESCHREIBUNG_GESUCH_STATUS_WECHSELN',\n            parentController: undefined,\n            elementID: undefined\n        }).then(() => {\n            return this.setGesuchStatus(TSAntragStatus.GEPRUEFT);\n        });\n    }\n\n    public closeWithoutAngebot(): IPromise<TSGesuch> {\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController, {\n            title: 'CONFIRM_GESUCH_STATUS_KEIN_ANGEBOT',\n            deleteText: 'BESCHREIBUNG_GESUCH_STATUS_WECHSELN',\n            parentController: undefined,\n            elementID: undefined\n\n        }).then(() => {\n            return this.gesuchRS.closeWithoutAngebot(this.gesuchModelManager.getGesuch().id).then((response) => {  // muss gespeichert werden um hasfsdokument zu aktualisieren\n                this.gesuchModelManager.setGesuch(response);\n                this.form.$setPristine(); // nach dem es gespeichert wird, muessen wir das Form wieder auf clean setzen\n                return this.refreshKinderListe().then(() => {\n                    return this.gesuchModelManager.getGesuch();\n                });\n            });\n        });\n    }\n\n    public setGesuchStatusVerfuegen(): IPromise<TSGesuch> {\n        let deleteTextValue: string = 'BESCHREIBUNG_GESUCH_STATUS_WECHSELN';\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController, {\n            title: 'CONFIRM_GESUCH_STATUS_VERFUEGEN',\n            deleteText: deleteTextValue,\n            parentController: undefined,\n            elementID: undefined\n        }).then(() => {\n\n            return this.gesuchRS.verfuegenStarten(\n                this.gesuchModelManager.getGesuch().id, this.gesuchModelManager.getGesuch().hasFSDokument).then((response) => {  // muss gespeichert werden um hasfsdokument zu aktualisieren\n                if (response.status === TSAntragStatus.NUR_SCHULAMT) {\n                    // If AntragStatus==NUR_SCHULAMT the Sachbearbeiter_JA has no rights to work with or even to see this gesuch any more\n                    // For this reason we have to navigate directly out of the gesuch once it has been saved. We navigate to the\n                    // default start page for the current role.\n                    // createNeededPDFs is not being called for the same reason. Anyway, the Gesuch vanishes for the role JA and is only\n                    // available for the role SCHULAMT/ADMINISTRATOR_SCHULAMT, so JA doesn't need the PDFs to be created. When a Schulamt worker opens this\n                    // Gesuch, she can generate the PDFs by clicking on the corresponding links\n                    AuthenticationUtil.navigateToStartPageForRole(this.authServiceRs.getPrincipal(), this.$state);\n                    return this.gesuchModelManager.getGesuch();\n                } else { // for NUR_SCHULAMT this makes no sense\n                    this.gesuchModelManager.setGesuch(response);\n                    this.form.$setPristine(); // nach dem es gespeichert wird, muessen wir das Form wieder auf clean setzen\n                    return this.refreshKinderListe().then(() => {\n                        return this.gesuchModelManager.getGesuch();\n                    });\n                }\n            });\n        });\n    }\n\n    private hasOffeneMahnungen(): boolean {\n        for (let mahn of this.mahnungList) {\n            if (!mahn.timestampAbgeschlossen) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    public sendToSteuerverwaltung(): void {\n        this.DvDialog.showDialog(bemerkungDialogTempl, BemerkungenDialogController, {\n            title: 'SEND_TO_STV_CONFIRMATION',\n            bemerkungen: this.gesuchModelManager.getGesuch().bemerkungenSTV\n        }).then((bemerkung: string) => {\n            this.gesuchRS.sendGesuchToSTV(this.getGesuch().id, bemerkung).then((gesuch: TSGesuch) => {\n                this.gesuchModelManager.setGesuch(gesuch);\n            });\n        });\n    }\n\n    public showSendToSteuerverwaltung(): boolean {\n        //hier wird extra nur \"VERFUEGT\" gestestet statt alle verfuegten status weil das Schulamt das Gesuch nicht pruefen lassen darf\n        return (this.gesuchModelManager.isGesuchStatus(TSAntragStatus.VERFUEGT) || this.gesuchModelManager.isGesuchStatus(TSAntragStatus.NUR_SCHULAMT))\n            && !this.getGesuch().gesperrtWegenBeschwerde;\n    }\n\n    public stvPruefungAbschliessen(): void {\n        this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController, {\n            title: 'STV_PRUEFUNG_ABSCHLIESSEN_CONFIRMATION',\n            deleteText: '',\n            parentController: undefined,\n            elementID: undefined\n        }).then((bemerkung: string) => {\n            this.gesuchRS.stvPruefungAbschliessen(this.getGesuch().id).then((gesuch: TSGesuch) => {\n                this.gesuchModelManager.setGesuch(gesuch);\n            });\n        });\n    }\n\n    public showSTVPruefungAbschliessen(): boolean {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus.GEPRUEFT_STV) && !this.getGesuch().gesperrtWegenBeschwerde;\n    }\n\n    public showErsteMahnungErstellen(): boolean {\n        // Nur wenn keine offenen Mahnungen vorhanden!\n        return (this.gesuchModelManager.isGesuchStatus(TSAntragStatus.IN_BEARBEITUNG_JA) || this.gesuchModelManager.isGesuchStatus(TSAntragStatus.FREIGEGEBEN))\n            && this.mahnung === undefined && !this.hasOffeneMahnungen() && !this.isGesuchReadonly();\n    }\n\n    public showErsteMahnungAusloesen(): boolean {\n        return this.mahnung !== undefined && this.mahnung.mahnungTyp === TSMahnungTyp.ERSTE_MAHNUNG\n            && !this.isGesuchReadonly();\n    }\n\n    public showZweiteMahnungErstellen(): boolean {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus.ERSTE_MAHNUNG_ABGELAUFEN)\n            && this.mahnung === undefined && !this.isGesuchReadonly();\n    }\n\n    public showZweiteMahnungAusloesen(): boolean {\n        return this.mahnung !== undefined && this.mahnung.mahnungTyp === TSMahnungTyp.ZWEITE_MAHNUNG\n            && !this.isGesuchReadonly();\n    }\n\n    /**\n     * Nur required in Status VERFUEGEN oder GEPRUEFT und wenn der Benutzer nicht am Erstellen einer Mahnung ist.\n     */\n    public isFinSitStatusRequired(): boolean {\n        return !this.showErsteMahnungAusloesen() && !this.showZweiteMahnungAusloesen()\n            && (this.getGesuch().status === TSAntragStatus.VERFUEGEN || this.getGesuch().status === TSAntragStatus.GEPRUEFT);\n    }\n\n    public showMahnlaufBeenden(): boolean {\n        return isAnyStatusOfMahnung(this.getGesuch().status) && !this.isGesuchReadonly();\n    }\n\n    public showDokumenteNichtKomplett(): boolean {\n        return isAnyStatusOfMahnung(this.getGesuch().status) && this.getGesuch().dokumenteHochgeladen\n            && !this.isGesuchReadonly();\n    }\n\n    public showZweiteMahnungNichtEingetreten(): boolean {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus.ZWEITE_MAHNUNG_ABGELAUFEN) && !this.isGesuchReadonly();\n    }\n\n    public ersteMahnungErstellen(): void {\n        this.tempAntragStatus = TSAntragStatus.ERSTE_MAHNUNG;\n        this.createMahnung(TSMahnungTyp.ERSTE_MAHNUNG);\n    }\n\n    public zweiteMahnungErstellen(): void {\n        this.tempAntragStatus = TSAntragStatus.ZWEITE_MAHNUNG;\n        this.createMahnung(TSMahnungTyp.ZWEITE_MAHNUNG);\n    }\n\n    public saveMahnung(): void {\n        if (this.form.$valid) {\n            this.mahnungRS.saveMahnung(this.mahnung).then((mahnungResponse: TSMahnung) => {\n                this.setGesuchStatus(this.tempAntragStatus).then(any => {\n                    this.mahnungList.push(mahnungResponse);\n                    this.tempAntragStatus = undefined;\n                    this.mahnung = undefined;\n                });\n            });\n        }\n    }\n\n    private createMahnung(typ: TSMahnungTyp): IPromise<any> {\n        return this.mahnungRS.getInitialeBemerkungen(this.getGesuch()).then(generatedBemerkungen => {\n            this.mahnung = new TSMahnung();\n            this.mahnung.mahnungTyp = typ;\n            this.mahnung.gesuch = this.getGesuch();\n            this.mahnung.timestampAbgeschlossen = null;\n            this.mahnung.bemerkungen = generatedBemerkungen.data;\n            if (this.getGesuchsperiode().hasTagesschulenAnmeldung() && this.getGesuch().areThereOnlySchulamtAngebote()) {\n                this.mahnung.datumFristablauf = moment(moment.now()).add(7, 'days');\n            }\n            return;\n        });\n    }\n\n    public mahnlaufBeenden(): void {\n        // Gesuchstatus zuruecksetzen UND die Mahnungen auf erledigt setzen\n        this.mahnungRS.mahnlaufBeenden(this.getGesuch()).then((gesuch: TSGesuch) => {\n            this.mahnungRS.findMahnungen(this.getGesuch().id).then(reloadedMahnungen => {\n                this.mahnungList = reloadedMahnungen;\n                this.gesuchModelManager.getGesuch().status = TSAntragStatus.IN_BEARBEITUNG_JA;\n            });\n        });\n    }\n\n    public dokumenteNichtKomplett(): void {\n        this.gesuchModelManager.getGesuch().dokumenteHochgeladen = false;\n        this.gesuchModelManager.updateGesuch();\n    }\n\n    public zweiteMahnungNichtEingetreten(): void {\n        // Auf die zweite Mahnung wurde nicht reagiert. Den Status des Gesuchs wieder auf IN_BEARBEITUNG setzen\n        // damit die Betreuungen auf NICHT_EINGETRETEN verfügt werden können. Die Mahnungen bleiben aber offen!\n        this.setGesuchStatus(TSAntragStatus.IN_BEARBEITUNG_JA);\n    }\n\n    /**\n     * Der Button Geprueft wird nur beim Status IN_BEARBEITUNG_JA eingeblendet\n     * @returns {boolean}\n     */\n    public showGeprueft(): boolean {\n        return (this.gesuchModelManager.isGesuchStatus(TSAntragStatus.IN_BEARBEITUNG_JA) || this.gesuchModelManager.isGesuchStatus(TSAntragStatus.FREIGEGEBEN))\n            && this.wizardStepManager.areAllStepsOK(this.getGesuch()) && this.mahnung === undefined\n            && !this.gesuchModelManager.areThereOnlySchulamtAngebote()\n            && !this.isGesuchReadonly();\n    }\n\n    /**\n     * Der Button Verfuegung starten wird angezeigt, wenn alle Betreuungen bestaetigt und das Gesuch geprueft wurden\n     * @returns {boolean}\n     */\n    public showVerfuegenStarten(): boolean {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus.GEPRUEFT)\n            && this.wizardStepManager.isStepStatusOk(TSWizardStepName.BETREUUNG)\n            && this.gesuchModelManager.getGesuch().isThereAnyBetreuung()\n            && !this.gesuchModelManager.areThereOnlySchulamtAngebote()\n            && !this.isGesuchReadonly();\n        // && this.gesuchModelManager.getGesuch().status !== TSAntragStatus.VERFUEGEN;\n    }\n\n    /**\n     * Nur wenn ein Gesuch keine Angebote hat und geprueft ist, kann man es ohne Angebote schliessen.\n     */\n    public showCloseWithoutAngebot(): boolean {\n        return this.gesuchModelManager.isGesuchStatus(TSAntragStatus.GEPRUEFT)\n            && !this.gesuchModelManager.getGesuch().isThereAnyBetreuung()\n            && !this.isGesuchReadonly();\n    }\n\n    /**\n     * ausblenden, wenn Gesuch readonly und finSitStatus nicht gesetzt (für alte Gesuche). Fuer GS nicht anzeigen.\n     */\n    public showFinSitStatus(): boolean {\n        return !(this.isGesuchReadonly() && EbeguUtil.isNullOrUndefined(this.getGesuch().finSitStatus))\n            && this.authServiceRs.isOneOfRoles(this.TSRoleUtil.getJugendamtAndSchulamtRole());\n    }\n\n    public openFinanzielleSituationPDF(): void {\n        let win: Window = this.downloadRS.prepareDownloadWindow();\n        this.downloadRS.getFinSitDokumentAccessTokenGeneratedDokument(this.gesuchModelManager.getGesuch().id)\n            .then((downloadFile: TSDownloadFile) => {\n                this.$log.debug('accessToken: ' + downloadFile.accessToken);\n                this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n            })\n            .catch((ex) => {\n                win.close();\n                this.$log.error('An error occurred downloading the document, closing download window.');\n            });\n    }\n\n    public openBegleitschreibenPDF(): void {\n        let win: Window = this.downloadRS.prepareDownloadWindow();\n        this.downloadRS.getBegleitschreibenDokumentAccessTokenGeneratedDokument(this.gesuchModelManager.getGesuch().id, false)\n            .then((downloadFile: TSDownloadFile) => {\n                this.$log.debug('accessToken: ' + downloadFile.accessToken);\n                this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n            })\n            .catch((ex) => {\n                win.close();\n                this.$log.error('An error occurred downloading the document, closing download window.');\n            });\n    }\n\n    public openMahnungPDF(mahnung: TSMahnung): void {\n        let win: Window = this.downloadRS.prepareDownloadWindow();\n        if (mahnung == null) {\n            mahnung = this.mahnung;\n        }\n        this.downloadRS.getAccessTokenMahnungGeneratedDokument(mahnung)\n            .then((downloadFile: TSDownloadFile) => {\n                this.$log.debug('accessToken: ' + downloadFile.accessToken);\n                this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n            })\n            .catch((ex) => {\n                win.close();\n                this.$log.error('An error occurred downloading the document, closing download window.');\n            });\n    }\n\n    public showBeschwerdeHaengig(): boolean {\n        let status: TSAntragStatus = this.getGesuch() ? this.getGesuch().status : TSAntragStatus.IN_BEARBEITUNG_GS;\n        // Schulamt Status duerfen keine Beschwerde starten\n        return isAnyStatusOfVerfuegt(status) && !this.getGesuch().gesperrtWegenBeschwerde;\n    }\n\n    public showBeschwerdeAbschliessen(): boolean {\n        let status: TSAntragStatus = this.getGesuch() ? this.getGesuch().status : TSAntragStatus.IN_BEARBEITUNG_GS;\n        return TSAntragStatus.BESCHWERDE_HAENGIG === status;\n    }\n\n    public showAbschliessen(): boolean {\n        let status: TSAntragStatus = this.getGesuch() ? this.getGesuch().status : TSAntragStatus.IN_BEARBEITUNG_GS;\n        return (TSAntragStatus.IN_BEARBEITUNG_JA === status || TSAntragStatus.GEPRUEFT === status)\n            && this.gesuchModelManager.areThereOnlySchulamtAngebote();\n    }\n\n    public isFinSitChoosen(): boolean {\n        if (this.getGesuch() && this.getGesuch().finSitStatus) {\n            return true;\n        }\n        return false;\n    }\n\n    public isFinSitAbglehnt() {\n        if (this.isFinSitChoosen() && this.getGesuch().finSitStatus !== TSFinSitStatus.AKZEPTIERT) {\n            return true;\n        }\n        return false;\n    }\n\n    public setAbschliessen(): IPromise<TSGesuch> {\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController, {\n            title: 'ABSCHLIESSEN',\n            deleteText: 'BESCHREIBUNG_GESUCH_ABSCHLIESSEN',\n            parentController: undefined,\n            elementID: undefined\n        }).then(() => {\n            return this.gesuchRS.setAbschliessen(this.getGesuch().id).then((gesuch: TSGesuch) => {\n                this.gesuchModelManager.setGesuch(gesuch);\n                return this.gesuchModelManager.getGesuch();\n            });\n        });\n    }\n\n    public setGesuchStatusBeschwerdeHaengig(): IPromise<TSGesuch> {\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController, {\n            title: 'BESCHWERDE_HAENGIG',\n            deleteText: 'BESCHREIBUNG_GESUCH_BESCHWERDE_HAENGIG',\n            parentController: undefined,\n            elementID: undefined\n        }).then(() => {\n            return this.gesuchRS.setBeschwerdeHaengig(this.getGesuch().id).then((gesuch: TSGesuch) => {\n                this.gesuchModelManager.setGesuch(gesuch);\n                return this.gesuchModelManager.getGesuch();\n            });\n        });\n    }\n\n    public setGesuchStatusBeschwerdeAbschliessen(): IPromise<TSGesuch> {\n        return this.DvDialog.showDialog(removeDialogTempl, RemoveDialogController, {\n            title: 'BESCHWERDE_ABSCHLIESSEN',\n            deleteText: 'BESCHREIBUNG_GESUCH_BESCHWERDE_ABSCHLIESSEN',\n            parentController: undefined,\n            elementID: undefined\n        }).then(() => {\n            return this.gesuchRS.removeBeschwerdeHaengig(this.getGesuch().id).then((gesuch: TSGesuch) => {\n                this.gesuchModelManager.setGesuch(gesuch);\n                return this.gesuchModelManager.getGesuch();\n            });\n        });\n    }\n\n    public changeFinSitStatus() {\n        if (this.getGesuch().finSitStatus) {\n            this.setHasFSDokumentAccordingToFinSitState();\n            this.gesuchRS.changeFinSitStatus(this.getGesuch().id, this.getGesuch().finSitStatus).then((response: any) => {\n                this.gesuchModelManager.setGesuch(this.getGesuch());\n                this.form.$setPristine();\n            });\n        }\n    }\n\n    private setHasFSDokumentAccordingToFinSitState() {\n        if (this.isFinSitAbglehnt()) {\n            this.getGesuch().hasFSDokument = false;\n        } else {\n            this.getGesuch().hasFSDokument = true;\n        }\n    }\n\n    public fsDokumentChanged(): void {\n        // dirty checker wird hier ausgeschaltet. Aenderungen des fs flag wird automatisch gespeichert wenn gesuch auf geprüft gesetzt wird\n        // Aus performance Gründen wird hier daruf verzichtet das Gesuch neu zu persisten, nur weil das Flag ändert.\n        this.form.$setPristine();\n    }\n\n    public isSuperAdmin(): boolean {\n        return this.authServiceRs.isRole(TSRole.SUPER_ADMIN);\n    }\n\n    $postLink() {\n        this.$timeout(() => {\n            EbeguUtil.selectFirst();\n        }, 500);\n    }\n}\n"]}]}