{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/core/service/mitteilungRS.rest.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/core/service/mitteilungRS.rest.ts","mtime":1518535855220},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\ndefine([\"require\", \"exports\", \"../../models/TSMitteilung\", \"../../models/enums/TSMitteilungTeilnehmerTyp\", \"../../models/enums/TSMitteilungStatus\", \"../../models/TSBetreuungsmitteilung\", \"../../utils/DateUtil\"], function (require, exports, TSMitteilung_1, TSMitteilungTeilnehmerTyp_1, TSMitteilungStatus_1, TSBetreuungsmitteilung_1, DateUtil_1) {\n    \"use strict\";\n    Object.defineProperty(exports, \"__esModule\", { value: true });\n    var MitteilungRS = /** @class */ (function () {\n        /* @ngInject */\n        function MitteilungRS($http, REST_API, ebeguRestUtil, $log, wizardStepManager, authServiceRS, $translate) {\n            this.wizardStepManager = wizardStepManager;\n            this.authServiceRS = authServiceRS;\n            this.$translate = $translate;\n            this.serviceURL = REST_API + 'mitteilungen';\n            this.http = $http;\n            this.ebeguRestUtil = ebeguRestUtil;\n            this.log = $log;\n        }\n        MitteilungRS.prototype.getServiceName = function () {\n            return 'MitteilungRS';\n        };\n        MitteilungRS.prototype.findMitteilung = function (mitteilungID) {\n            var _this = this;\n            return this.http.get(this.serviceURL + '/' + encodeURIComponent(mitteilungID))\n                .then(function (response) {\n                _this.log.debug('PARSING Mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilung(new TSMitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.sendMitteilung = function (mitteilung) {\n            var _this = this;\n            var restMitteilung = {};\n            restMitteilung = this.ebeguRestUtil.mitteilungToRestObject(restMitteilung, mitteilung);\n            return this.http.put(this.serviceURL + '/send', restMitteilung, {\n                headers: {\n                    'Content-Type': 'application/json'\n                }\n            }).then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilung(new TSMitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.saveEntwurf = function (mitteilung) {\n            var _this = this;\n            var restMitteilung = {};\n            restMitteilung = this.ebeguRestUtil.mitteilungToRestObject(restMitteilung, mitteilung);\n            return this.http.put(this.serviceURL + '/entwurf', restMitteilung, {\n                headers: {\n                    'Content-Type': 'application/json'\n                }\n            }).then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilung(new TSMitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.setMitteilungGelesen = function (mitteilungId) {\n            var _this = this;\n            return this.http.put(this.serviceURL + '/setgelesen/' + mitteilungId, null).then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilung(new TSMitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.setMitteilungErledigt = function (mitteilungId) {\n            var _this = this;\n            return this.http.put(this.serviceURL + '/seterledigt/' + mitteilungId, null).then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilung(new TSMitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.getEntwurfForCurrentRolleForFall = function (fallId) {\n            var _this = this;\n            return this.http.get(this.serviceURL + '/entwurf/fall/' + fallId).then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilung(new TSMitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.getEntwurfForCurrentRolleForBetreuung = function (betreuungId) {\n            var _this = this;\n            return this.http.get(this.serviceURL + '/entwurf/betreuung/' + betreuungId).then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilung(new TSMitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.getMitteilungenForCurrentRolleForFall = function (fallId) {\n            var _this = this;\n            return this.http.get(this.serviceURL + '/forrole/fall/' + fallId).then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilungen(response.data.mitteilungen); // The response is a wrapper\n            });\n        };\n        MitteilungRS.prototype.getMitteilungenForCurrentRolleForBetreuung = function (betreuungId) {\n            var _this = this;\n            return this.http.get(this.serviceURL + '/forrole/betreuung/' + betreuungId).then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilungen(response.data.mitteilungen); // The response is a wrapper\n            });\n        };\n        MitteilungRS.prototype.getMitteilungenForPosteingang = function () {\n            var _this = this;\n            return this.http.get(this.serviceURL + '/posteingang').then(function (response) {\n                _this.log.debug('PARSING mitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseMitteilungen(response.data.mitteilungen); // The response is a wrapper\n            });\n        };\n        MitteilungRS.prototype.getAmountMitteilungenForCurrentBenutzer = function () {\n            return this.http.get(this.serviceURL + '/amountnewforuser/notokenrefresh').then(function (response) {\n                return response.data;\n            });\n        };\n        MitteilungRS.prototype.removeEntwurf = function (mitteilung) {\n            return this.http.delete(this.serviceURL + '/' + encodeURIComponent(mitteilung.id))\n                .then(function (response) {\n                return response;\n            });\n        };\n        MitteilungRS.prototype.setAllNewMitteilungenOfFallGelesen = function (fallId) {\n            var _this = this;\n            return this.http.put(this.serviceURL + '/setallgelesen/' + fallId, null).then(function (response) {\n                _this.log.debug('PARSING mitteilungen REST objects ', response.data);\n                return _this.ebeguRestUtil.parseMitteilungen(response.data.mitteilungen); // The response is a wrapper\n            });\n        };\n        MitteilungRS.prototype.getAmountNewMitteilungenForCurrentRolle = function (fallId) {\n            return this.http.get(this.serviceURL + '/amountnew/' + fallId).then(function (response) {\n                return response.data;\n            });\n        };\n        MitteilungRS.prototype.sendbetreuungsmitteilung = function (fall, betreuung) {\n            var _this = this;\n            var mutationsmeldung = this.createBetreuungsmitteilung(fall, betreuung);\n            var restMitteilung = this.ebeguRestUtil.betreuungsmitteilungToRestObject({}, mutationsmeldung);\n            return this.http.put(this.serviceURL + '/sendbetreuungsmitteilung', restMitteilung, {\n                headers: {\n                    'Content-Type': 'application/json'\n                }\n            }).then(function (response) {\n                _this.log.debug('PARSING Betreuungsmitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseBetreuungsmitteilung(new TSBetreuungsmitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.applyBetreuungsmitteilung = function (betreuungsmitteilungId) {\n            return this.http.put(this.serviceURL + '/applybetreuungsmitteilung/' + betreuungsmitteilungId, null, {\n                headers: {\n                    'Content-Type': 'application/json'\n                }\n            }).then(function (response) {\n                return response.data;\n            });\n        };\n        MitteilungRS.prototype.getNewestBetreuungsmitteilung = function (betreuungId) {\n            var _this = this;\n            return this.http.get(this.serviceURL + '/newestBetreuunsmitteilung/' + betreuungId).then(function (response) {\n                _this.log.debug('PARSING Betreuungsmitteilung REST object ', response.data);\n                return _this.ebeguRestUtil.parseBetreuungsmitteilung(new TSBetreuungsmitteilung_1.default(), response.data);\n            });\n        };\n        MitteilungRS.prototype.createBetreuungsmitteilung = function (fall, betreuung) {\n            var mutationsmeldung = new TSBetreuungsmitteilung_1.default();\n            mutationsmeldung.fall = fall;\n            mutationsmeldung.betreuung = betreuung;\n            mutationsmeldung.senderTyp = TSMitteilungTeilnehmerTyp_1.TSMitteilungTeilnehmerTyp.INSTITUTION;\n            mutationsmeldung.empfaengerTyp = TSMitteilungTeilnehmerTyp_1.TSMitteilungTeilnehmerTyp.JUGENDAMT;\n            mutationsmeldung.sender = this.authServiceRS.getPrincipal();\n            mutationsmeldung.empfaenger = fall.besitzer ? fall.besitzer : undefined;\n            mutationsmeldung.subject = this.$translate.instant('MUTATIONSMELDUNG_BETREFF');\n            mutationsmeldung.message = this.createNachrichtForMutationsmeldung(betreuung);\n            mutationsmeldung.mitteilungStatus = TSMitteilungStatus_1.TSMitteilungStatus.ENTWURF;\n            mutationsmeldung.betreuungspensen = this.extractPensenFromBetreuung(betreuung);\n            return mutationsmeldung;\n        };\n        /**\n         * Erzeugt eine Nachricht mit einem Text mit allen Betreuungspensen der Betreuung.\n         */\n        MitteilungRS.prototype.createNachrichtForMutationsmeldung = function (betreuung) {\n            var _this = this;\n            var message = '';\n            var i = 1;\n            var betreuungspensumContainers = angular.copy(betreuung.betreuungspensumContainers); // to avoid changing something\n            betreuungspensumContainers\n                .sort(function (a, b) {\n                return DateUtil_1.default.compareDateTime(a.betreuungspensumJA.gueltigkeit.gueltigAb, b.betreuungspensumJA.gueltigkeit.gueltigAb);\n            }).forEach(function (betpenContainer) {\n                if (betpenContainer.betreuungspensumJA) {\n                    // z.B. -> Pensum 1 vom 1.8.2017 bis 31.07.2018: 80%\n                    if (i > 1) {\n                        message += '\\n';\n                    }\n                    var datumAb = DateUtil_1.default.momentToLocalDateFormat(betpenContainer.betreuungspensumJA.gueltigkeit.gueltigAb, 'DD.MM.YYYY');\n                    var datumBis = DateUtil_1.default.momentToLocalDateFormat(betpenContainer.betreuungspensumJA.gueltigkeit.gueltigBis, 'DD.MM.YYYY');\n                    datumBis = datumBis ? datumBis : DateUtil_1.default.momentToLocalDateFormat(betreuung.gesuchsperiode.gueltigkeit.gueltigBis, 'DD.MM.YYYY'); // by default Ende der Periode\n                    message += _this.$translate.instant('MUTATIONSMELDUNG_PENSUM') + i\n                        + _this.$translate.instant('MUTATIONSMELDUNG_VON') + datumAb\n                        + _this.$translate.instant('MUTATIONSMELDUNG_BIS') + datumBis\n                        + ': ' + betpenContainer.betreuungspensumJA.pensum + '%';\n                }\n                i++;\n            });\n            return message;\n        };\n        /**\n         * Kopiert alle Betreuungspensen der gegebenen Betreuung in einer neuen Liste und\n         * gibt diese zurueck. By default wird eine leere Liste zurueckgegeben\n         */\n        MitteilungRS.prototype.extractPensenFromBetreuung = function (betreuung) {\n            var pensen = [];\n            betreuung.betreuungspensumContainers.forEach(function (betpenContainer) {\n                var pensumJA = angular.copy(betpenContainer.betreuungspensumJA);\n                pensumJA.id = undefined; // the id must be set to undefined in order no to duplicate it\n                pensen.push(pensumJA);\n            });\n            return pensen;\n        };\n        MitteilungRS.$inject = ['$http', 'REST_API', 'EbeguRestUtil', '$log', 'WizardStepManager',\n            'AuthServiceRS', '$translate'];\n        return MitteilungRS;\n    }());\n    exports.default = MitteilungRS;\n});\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/core/service/mitteilungRS.rest.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/core/service/mitteilungRS.rest.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport EbeguRestUtil from '../../utils/EbeguRestUtil';\nimport {IHttpService, ILogService, IPromise} from 'angular';\nimport WizardStepManager from '../../gesuch/service/wizardStepManager';\nimport TSMitteilung from '../../models/TSMitteilung';\nimport TSBetreuung from '../../models/TSBetreuung';\nimport {TSMitteilungTeilnehmerTyp} from '../../models/enums/TSMitteilungTeilnehmerTyp';\nimport {TSMitteilungStatus} from '../../models/enums/TSMitteilungStatus';\nimport TSFall from '../../models/TSFall';\nimport AuthServiceRS from '../../authentication/service/AuthServiceRS.rest';\nimport TSBetreuungsmitteilung from '../../models/TSBetreuungsmitteilung';\nimport TSBetreuungspensum from '../../models/TSBetreuungspensum';\nimport DateUtil from '../../utils/DateUtil';\nimport TSBetreuungspensumContainer from '../../models/TSBetreuungspensumContainer';\nimport ITranslateService = angular.translate.ITranslateService;\n\nexport default class MitteilungRS {\n    serviceURL: string;\n    http: IHttpService;\n    ebeguRestUtil: EbeguRestUtil;\n    log: ILogService;\n\n    static $inject = ['$http', 'REST_API', 'EbeguRestUtil', '$log', 'WizardStepManager',\n        'AuthServiceRS', '$translate'];\n    /* @ngInject */\n    constructor($http: IHttpService, REST_API: string, ebeguRestUtil: EbeguRestUtil, $log: ILogService,\n                private wizardStepManager: WizardStepManager, private authServiceRS: AuthServiceRS,\n                private $translate: ITranslateService) {\n        this.serviceURL = REST_API + 'mitteilungen';\n        this.http = $http;\n        this.ebeguRestUtil = ebeguRestUtil;\n        this.log = $log;\n    }\n\n    public getServiceName(): string {\n        return 'MitteilungRS';\n    }\n\n    public findMitteilung(mitteilungID: string): IPromise<TSMitteilung> {\n        return this.http.get(this.serviceURL + '/' + encodeURIComponent(mitteilungID))\n            .then((response: any) => {\n                this.log.debug('PARSING Mitteilung REST object ', response.data);\n                return this.ebeguRestUtil.parseMitteilung(new TSMitteilung(), response.data);\n            });\n    }\n\n    public sendMitteilung(mitteilung: TSMitteilung): IPromise<TSMitteilung> {\n        let restMitteilung = {};\n        restMitteilung = this.ebeguRestUtil.mitteilungToRestObject(restMitteilung, mitteilung);\n        return this.http.put(this.serviceURL + '/send', restMitteilung, {\n            headers: {\n                'Content-Type': 'application/json'\n            }\n        }).then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilung(new TSMitteilung(), response.data);\n        });\n    }\n\n    public saveEntwurf(mitteilung: TSMitteilung): IPromise<TSMitteilung> {\n        let restMitteilung = {};\n        restMitteilung = this.ebeguRestUtil.mitteilungToRestObject(restMitteilung, mitteilung);\n        return this.http.put(this.serviceURL + '/entwurf', restMitteilung, {\n            headers: {\n                'Content-Type': 'application/json'\n            }\n        }).then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilung(new TSMitteilung(), response.data);\n        });\n    }\n\n    public setMitteilungGelesen(mitteilungId: string): IPromise<TSMitteilung> {\n        return this.http.put(this.serviceURL + '/setgelesen/' + mitteilungId, null).then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilung(new TSMitteilung(), response.data);\n        });\n    }\n\n    public setMitteilungErledigt(mitteilungId: string): IPromise<TSMitteilung> {\n        return this.http.put(this.serviceURL + '/seterledigt/' + mitteilungId, null).then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilung(new TSMitteilung(), response.data);\n        });\n    }\n\n    public getEntwurfForCurrentRolleForFall(fallId: string): IPromise<TSMitteilung> {\n        return this.http.get(this.serviceURL + '/entwurf/fall/' + fallId).then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilung(new TSMitteilung(), response.data);\n        });\n    }\n\n    public getEntwurfForCurrentRolleForBetreuung(betreuungId: string): IPromise<TSMitteilung> {\n        return this.http.get(this.serviceURL + '/entwurf/betreuung/' + betreuungId).then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilung(new TSMitteilung(), response.data);\n        });\n    }\n\n    public getMitteilungenForCurrentRolleForFall(fallId: string): IPromise<Array<TSMitteilung>> {\n        return this.http.get(this.serviceURL + '/forrole/fall/' + fallId).then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilungen(response.data.mitteilungen); // The response is a wrapper\n        });\n    }\n\n    public getMitteilungenForCurrentRolleForBetreuung(betreuungId: string): IPromise<Array<TSMitteilung>> {\n        return this.http.get(this.serviceURL + '/forrole/betreuung/' + betreuungId).then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilungen(response.data.mitteilungen); // The response is a wrapper\n        });\n    }\n\n    public getMitteilungenForPosteingang(): IPromise<Array<TSMitteilung>> {\n        return this.http.get(this.serviceURL + '/posteingang').then((response: any) => {\n            this.log.debug('PARSING mitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseMitteilungen(response.data.mitteilungen); // The response is a wrapper\n        });\n    }\n\n    public getAmountMitteilungenForCurrentBenutzer(): IPromise<number> {\n        return this.http.get(this.serviceURL + '/amountnewforuser/notokenrefresh').then((response: any) => {\n            return response.data;\n        });\n    }\n\n    public removeEntwurf(mitteilung: TSMitteilung): IPromise<any> {\n        return this.http.delete(this.serviceURL + '/' + encodeURIComponent(mitteilung.id))\n            .then((response) => {\n                return response;\n            });\n    }\n\n    public setAllNewMitteilungenOfFallGelesen(fallId: string): IPromise<Array<TSMitteilung>> {\n        return this.http.put(this.serviceURL + '/setallgelesen/' + fallId, null).then((response: any) => {\n            this.log.debug('PARSING mitteilungen REST objects ', response.data);\n            return this.ebeguRestUtil.parseMitteilungen(response.data.mitteilungen); // The response is a wrapper\n        });\n    }\n\n    public getAmountNewMitteilungenForCurrentRolle(fallId: string): IPromise<number> {\n        return this.http.get(this.serviceURL + '/amountnew/' + fallId).then((response: any) => {\n            return response.data;\n        });\n    }\n\n    public sendbetreuungsmitteilung(fall: TSFall, betreuung: TSBetreuung): IPromise<TSBetreuungsmitteilung> {\n        let mutationsmeldung: TSBetreuungsmitteilung = this.createBetreuungsmitteilung(fall, betreuung);\n        let restMitteilung: any = this.ebeguRestUtil.betreuungsmitteilungToRestObject({}, mutationsmeldung);\n        return this.http.put(this.serviceURL + '/sendbetreuungsmitteilung', restMitteilung, {\n            headers: {\n                'Content-Type': 'application/json'\n            }\n        }).then((response: any) => {\n            this.log.debug('PARSING Betreuungsmitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseBetreuungsmitteilung(new TSBetreuungsmitteilung(), response.data);\n        });\n    }\n\n    public applyBetreuungsmitteilung(betreuungsmitteilungId: string): IPromise<string> {\n        return this.http.put(this.serviceURL + '/applybetreuungsmitteilung/' + betreuungsmitteilungId, null, {\n            headers: {\n                'Content-Type': 'application/json'\n            }\n        }).then((response: any) => {\n            return response.data;\n        });\n    }\n\n    public getNewestBetreuungsmitteilung(betreuungId: string): IPromise<TSBetreuungsmitteilung> {\n        return this.http.get(this.serviceURL + '/newestBetreuunsmitteilung/' + betreuungId).then((response: any) => {\n            this.log.debug('PARSING Betreuungsmitteilung REST object ', response.data);\n            return this.ebeguRestUtil.parseBetreuungsmitteilung(new TSBetreuungsmitteilung(), response.data);\n        });\n    }\n\n\n    private createBetreuungsmitteilung(fall: TSFall, betreuung: TSBetreuung): TSBetreuungsmitteilung {\n        let mutationsmeldung: TSBetreuungsmitteilung = new TSBetreuungsmitteilung();\n        mutationsmeldung.fall = fall;\n        mutationsmeldung.betreuung = betreuung;\n        mutationsmeldung.senderTyp = TSMitteilungTeilnehmerTyp.INSTITUTION;\n        mutationsmeldung.empfaengerTyp = TSMitteilungTeilnehmerTyp.JUGENDAMT;\n        mutationsmeldung.sender = this.authServiceRS.getPrincipal();\n        mutationsmeldung.empfaenger = fall.besitzer ? fall.besitzer : undefined;\n        mutationsmeldung.subject = this.$translate.instant('MUTATIONSMELDUNG_BETREFF');\n        mutationsmeldung.message = this.createNachrichtForMutationsmeldung(betreuung);\n        mutationsmeldung.mitteilungStatus = TSMitteilungStatus.ENTWURF;\n        mutationsmeldung.betreuungspensen = this.extractPensenFromBetreuung(betreuung);\n        return mutationsmeldung;\n    }\n\n    /**\n     * Erzeugt eine Nachricht mit einem Text mit allen Betreuungspensen der Betreuung.\n     */\n    private createNachrichtForMutationsmeldung(betreuung: TSBetreuung): string {\n        let message: string = '';\n        let i: number = 1;\n        let betreuungspensumContainers: Array<TSBetreuungspensumContainer> = angular.copy(betreuung.betreuungspensumContainers); // to avoid changing something\n        betreuungspensumContainers\n            .sort(\n                (a: TSBetreuungspensumContainer, b: TSBetreuungspensumContainer) => {\n                    return DateUtil.compareDateTime(a.betreuungspensumJA.gueltigkeit.gueltigAb, b.betreuungspensumJA.gueltigkeit.gueltigAb);\n                }\n            ).forEach(betpenContainer => {\n            if (betpenContainer.betreuungspensumJA) {\n                // z.B. -> Pensum 1 vom 1.8.2017 bis 31.07.2018: 80%\n                if (i > 1) {\n                    message += '\\n';\n                }\n                let datumAb: string = DateUtil.momentToLocalDateFormat(betpenContainer.betreuungspensumJA.gueltigkeit.gueltigAb, 'DD.MM.YYYY');\n                let datumBis: string = DateUtil.momentToLocalDateFormat(betpenContainer.betreuungspensumJA.gueltigkeit.gueltigBis, 'DD.MM.YYYY');\n                datumBis = datumBis ? datumBis : DateUtil.momentToLocalDateFormat(betreuung.gesuchsperiode.gueltigkeit.gueltigBis, 'DD.MM.YYYY'); // by default Ende der Periode\n                message += this.$translate.instant('MUTATIONSMELDUNG_PENSUM') + i\n                    + this.$translate.instant('MUTATIONSMELDUNG_VON') + datumAb\n                    + this.$translate.instant('MUTATIONSMELDUNG_BIS') + datumBis\n                    + ': ' + betpenContainer.betreuungspensumJA.pensum + '%';\n            }\n            i++;\n        });\n        return message;\n    }\n\n    /**\n     * Kopiert alle Betreuungspensen der gegebenen Betreuung in einer neuen Liste und\n     * gibt diese zurueck. By default wird eine leere Liste zurueckgegeben\n     */\n    private extractPensenFromBetreuung(betreuung: TSBetreuung): Array<TSBetreuungspensum> {\n        let pensen: Array<TSBetreuungspensum> = [];\n        betreuung.betreuungspensumContainers.forEach(betpenContainer => {\n            let pensumJA = angular.copy(betpenContainer.betreuungspensumJA);\n            pensumJA.id = undefined; // the id must be set to undefined in order no to duplicate it\n            pensen.push(pensumJA);\n        });\n        return pensen;\n    }\n}\n"]}]}