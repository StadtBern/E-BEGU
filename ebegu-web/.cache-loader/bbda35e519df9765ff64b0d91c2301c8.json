{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuchstellerDashboard/component/angebot/createAngebotView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuchstellerDashboard/component/angebot/createAngebotView.ts","mtime":1518612642528},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar TSBetreuungsangebotTyp_1 = require(\"../../../models/enums/TSBetreuungsangebotTyp\");\nvar TSBetreuung_1 = require(\"../../../models/TSBetreuung\");\nvar TSBelegungTagesschule_1 = require(\"../../../models/TSBelegungTagesschule\");\nvar DateUtil_1 = require(\"../../../utils/DateUtil\");\nvar TSBetreuungsstatus_1 = require(\"../../../models/enums/TSBetreuungsstatus\");\nvar TSAnmeldungDTO_1 = require(\"../../../models/TSAnmeldungDTO\");\nvar OkDialogController_1 = require(\"../../../gesuch/dialog/OkDialogController\");\nvar TSBelegungFerieninsel_1 = require(\"../../../models/TSBelegungFerieninsel\");\nvar template = require('./createAngebotView.html');\nrequire('./createAngebotView.less');\nvar okDialogTempl = require('../../../gesuch/dialog/okDialogTemplate.html');\nvar CreateAngebotListViewConfig = /** @class */ (function () {\n    function CreateAngebotListViewConfig() {\n        this.transclude = false;\n        this.template = template;\n        this.controller = CreateAngebotListViewController;\n        this.controllerAs = 'vm';\n    }\n    return CreateAngebotListViewConfig;\n}());\nexports.CreateAngebotListViewConfig = CreateAngebotListViewConfig;\nvar CreateAngebotListViewController = /** @class */ (function () {\n    function CreateAngebotListViewController($state, $log, gesuchModelManager, $stateParams, betreuungRS, dvDialog) {\n        this.$state = $state;\n        this.$log = $log;\n        this.gesuchModelManager = gesuchModelManager;\n        this.$stateParams = $stateParams;\n        this.betreuungRS = betreuungRS;\n        this.dvDialog = dvDialog;\n        this.anmeldungDTO = new TSAnmeldungDTO_1.default;\n    }\n    CreateAngebotListViewController.prototype.$onInit = function () {\n        this.anmeldungDTO = new TSAnmeldungDTO_1.default();\n        if (this.$stateParams.type === 'TS') {\n            this.ts = true;\n        }\n        else if (this.$stateParams.type === 'FI') {\n            this.fi = true;\n        }\n        else {\n            console.error('type must be set!');\n            this.backToHome();\n        }\n    };\n    CreateAngebotListViewController.prototype.getGesuchsperiodeString = function () {\n        return this.gesuchModelManager.getGesuchsperiode().gesuchsperiodeString;\n    };\n    CreateAngebotListViewController.prototype.getInstitutionenSDList = function () {\n        var _this = this;\n        var result = [];\n        /*if (this.betreuungsangebot) {*/\n        this.gesuchModelManager.getActiveInstitutionenList().forEach(function (instStamm) {\n            if (_this.ts) {\n                if (instStamm.betreuungsangebotTyp === TSBetreuungsangebotTyp_1.TSBetreuungsangebotTyp.TAGESSCHULE && _this.gesuchModelManager.isDefaultTagesschuleAllowed(instStamm)) {\n                    result.push(instStamm);\n                }\n            }\n            else if (_this.fi) {\n                if (instStamm.betreuungsangebotTyp === TSBetreuungsangebotTyp_1.TSBetreuungsangebotTyp.FERIENINSEL) {\n                    result.push(instStamm);\n                }\n            }\n        });\n        return result;\n    };\n    CreateAngebotListViewController.prototype.getKindContainerList = function () {\n        return this.gesuchModelManager.getGesuch().kindContainers;\n    };\n    CreateAngebotListViewController.prototype.showInstitutionSelect = function () {\n        return !!this.kindContainer;\n    };\n    CreateAngebotListViewController.prototype.displayModuleTagesschule = function () {\n        return this.ts && !!this.institution;\n    };\n    CreateAngebotListViewController.prototype.displayModuleFerieninsel = function () {\n        return this.fi && !!this.institution;\n    };\n    CreateAngebotListViewController.prototype.selectedInstitutionStammdatenChanged = function () {\n        if (!this.anmeldungDTO.betreuung) {\n            this.anmeldungDTO.betreuung = new TSBetreuung_1.default();\n        }\n        this.anmeldungDTO.betreuung.institutionStammdaten = this.institution;\n        // Default Eintrittsdatum ist erster Schultag, wenn noch in Zukunft\n        if (this.ts) {\n            // Nur fuer die neuen Gesuchsperiode kann die Belegung erfast werden\n            if (this.gesuchModelManager.getGesuchsperiode().hasTagesschulenAnmeldung()\n                && this.isTageschulenAnmeldungAktiv()) {\n                this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus_1.TSBetreuungsstatus.SCHULAMT_ANMELDUNG_ERFASST;\n                if (!this.anmeldungDTO.betreuung.belegungTagesschule) {\n                    this.anmeldungDTO.betreuung.belegungTagesschule = new TSBelegungTagesschule_1.default();\n                    // Default Eintrittsdatum ist erster Schultag, wenn noch in Zukunft\n                    var ersterSchultag = this.gesuchModelManager.getGesuchsperiode().datumErsterSchultag;\n                    if (DateUtil_1.default.today().isBefore(ersterSchultag)) {\n                        this.anmeldungDTO.betreuung.belegungTagesschule.eintrittsdatum = ersterSchultag;\n                    }\n                }\n            }\n            else {\n                // \"Alte\" Tagesschule: Noch keine Modulanmeldung moeglich. Wir setzen Default-Institution\n                this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus_1.TSBetreuungsstatus.SCHULAMT;\n            }\n            this.anmeldungDTO.betreuung.belegungFerieninsel = undefined;\n        }\n        else {\n            if (!this.anmeldungDTO.betreuung.belegungFerieninsel) {\n                this.anmeldungDTO.betreuung.belegungFerieninsel = new TSBelegungFerieninsel_1.default();\n            }\n            this.anmeldungDTO.betreuung.belegungTagesschule = undefined;\n        }\n    };\n    CreateAngebotListViewController.prototype.isTageschulenAnmeldungAktiv = function () {\n        return this.gesuchModelManager.getGesuchsperiode().isTageschulenAnmeldungAktiv();\n    };\n    CreateAngebotListViewController.prototype.selectedKindChanged = function () {\n        if (this.kindContainer) {\n            this.anmeldungDTO.additionalKindQuestions = !this.kindContainer.kindJA.familienErgaenzendeBetreuung;\n            this.anmeldungDTO.kindContainerId = this.kindContainer.id;\n        }\n    };\n    CreateAngebotListViewController.prototype.getDatumEinschulung = function () {\n        return this.gesuchModelManager.getGesuchsperiodeBegin();\n    };\n    CreateAngebotListViewController.prototype.anmeldenSchulamt = function () {\n        var _this = this;\n        if (this.ts) {\n            this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus_1.TSBetreuungsstatus.SCHULAMT_ANMELDUNG_AUSGELOEST;\n            this.anmeldungDTO.betreuung.belegungTagesschule.moduleTagesschule = this.anmeldungDTO.betreuung.belegungTagesschule.moduleTagesschule\n                .filter(function (modul) { return modul.angemeldet === true; });\n            this.betreuungRS.createAngebot(this.anmeldungDTO).then(function (response) {\n                _this.dvDialog.showDialog(okDialogTempl, OkDialogController_1.OkDialogController, {\n                    title: 'TAGESSCHULE_ANMELDUNG_GESPEICHERT'\n                }).then(function () {\n                    _this.backToHome();\n                });\n            }).catch(function () {\n                _this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus_1.TSBetreuungsstatus.AUSSTEHEND;\n            });\n        }\n        else if (this.fi) {\n            this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus_1.TSBetreuungsstatus.SCHULAMT_ANMELDUNG_AUSGELOEST;\n            this.betreuungRS.createAngebot(this.anmeldungDTO).then(function (response) {\n                _this.kindContainer.kindJA.familienErgaenzendeBetreuung = true;\n                _this.dvDialog.showDialog(okDialogTempl, OkDialogController_1.OkDialogController, {\n                    title: 'FERIENINSEL_ANMELDUNG_GESPEICHERT'\n                }).then(function () {\n                    _this.backToHome();\n                });\n            }).catch(function () {\n                _this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus_1.TSBetreuungsstatus.AUSSTEHEND;\n            });\n        }\n    };\n    CreateAngebotListViewController.prototype.backToHome = function () {\n        this.form.$setPristine();\n        this.$state.go('gesuchstellerDashboard');\n    };\n    CreateAngebotListViewController.$inject = ['$state', '$log', 'GesuchModelManager', '$stateParams', 'BetreuungRS', 'DvDialog'];\n    return CreateAngebotListViewController;\n}());\nexports.CreateAngebotListViewController = CreateAngebotListViewController;\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuchstellerDashboard/component/angebot/createAngebotView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuchstellerDashboard/component/angebot/createAngebotView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nimport {IComponentOptions} from 'angular';\nimport {IStateService} from 'angular-ui-router';\nimport TSInstitutionStammdaten from '../../../models/TSInstitutionStammdaten';\nimport GesuchModelManager from '../../../gesuch/service/gesuchModelManager';\nimport {IAngebotStateParams} from '../../gesuchstellerDashboard.route';\nimport {TSBetreuungsangebotTyp} from '../../../models/enums/TSBetreuungsangebotTyp';\nimport TSKindContainer from '../../../models/TSKindContainer';\nimport TSBetreuung from '../../../models/TSBetreuung';\nimport TSBelegungTagesschule from '../../../models/TSBelegungTagesschule';\nimport * as moment from 'moment';\nimport DateUtil from '../../../utils/DateUtil';\nimport {TSBetreuungsstatus} from '../../../models/enums/TSBetreuungsstatus';\nimport TSAnmeldungDTO from '../../../models/TSAnmeldungDTO';\nimport BetreuungRS from '../../../core/service/betreuungRS.rest';\nimport {OkDialogController} from '../../../gesuch/dialog/OkDialogController';\nimport {DvDialog} from '../../../core/directive/dv-dialog/dv-dialog';\nimport ILogService = angular.ILogService;\nimport IFormController = angular.IFormController;\nimport TSBelegungFerieninsel from '../../../models/TSBelegungFerieninsel';\n\nlet template = require('./createAngebotView.html');\nrequire('./createAngebotView.less');\nlet okDialogTempl = require('../../../gesuch/dialog/okDialogTemplate.html');\n\nexport class CreateAngebotListViewConfig implements IComponentOptions {\n    transclude = false;\n    template = template;\n    controller = CreateAngebotListViewController;\n    controllerAs = 'vm';\n}\n\nexport class CreateAngebotListViewController {\n\n    form: IFormController;\n    private ts: boolean;\n    private fi: boolean;\n    private kindContainer: TSKindContainer;\n    private institution: TSInstitutionStammdaten;\n    private anmeldungDTO: TSAnmeldungDTO = new TSAnmeldungDTO;\n\n    static $inject: string[] = ['$state', '$log', 'GesuchModelManager', '$stateParams', 'BetreuungRS', 'DvDialog'];\n\n    constructor(private $state: IStateService, private $log: ILogService,\n                private gesuchModelManager: GesuchModelManager, private $stateParams: IAngebotStateParams,\n                private betreuungRS: BetreuungRS, private dvDialog: DvDialog) {\n    }\n\n    $onInit() {\n        this.anmeldungDTO = new TSAnmeldungDTO();\n        if (this.$stateParams.type === 'TS') {\n            this.ts = true;\n        } else if (this.$stateParams.type === 'FI') {\n            this.fi = true;\n        } else {\n            console.error('type must be set!');\n            this.backToHome();\n        }\n    }\n\n    public getGesuchsperiodeString(): string {\n        return this.gesuchModelManager.getGesuchsperiode().gesuchsperiodeString;\n    }\n\n    public getInstitutionenSDList(): Array<TSInstitutionStammdaten> {\n        let result: Array<TSInstitutionStammdaten> = [];\n        /*if (this.betreuungsangebot) {*/\n        this.gesuchModelManager.getActiveInstitutionenList().forEach((instStamm: TSInstitutionStammdaten) => {\n            if (this.ts) {\n                if (instStamm.betreuungsangebotTyp === TSBetreuungsangebotTyp.TAGESSCHULE && this.gesuchModelManager.isDefaultTagesschuleAllowed(instStamm)) {\n                    result.push(instStamm);\n                }\n            } else if (this.fi) {\n                if (instStamm.betreuungsangebotTyp === TSBetreuungsangebotTyp.FERIENINSEL) {\n                    result.push(instStamm);\n                }\n            }\n        });\n        return result;\n    }\n\n    public getKindContainerList(): Array<TSKindContainer> {\n\n        return this.gesuchModelManager.getGesuch().kindContainers;\n\n    }\n\n    public showInstitutionSelect(): boolean {\n        return !!this.kindContainer;\n    }\n\n    public displayModuleTagesschule(): boolean {\n        return this.ts && !!this.institution;\n    }\n\n    public displayModuleFerieninsel(): boolean {\n        return this.fi && !!this.institution;\n    }\n\n    public selectedInstitutionStammdatenChanged(): void {\n        if (!this.anmeldungDTO.betreuung) {\n            this.anmeldungDTO.betreuung = new TSBetreuung();\n        }\n        this.anmeldungDTO.betreuung.institutionStammdaten = this.institution;\n        // Default Eintrittsdatum ist erster Schultag, wenn noch in Zukunft\n\n        if (this.ts) {\n            // Nur fuer die neuen Gesuchsperiode kann die Belegung erfast werden\n            if (this.gesuchModelManager.getGesuchsperiode().hasTagesschulenAnmeldung()\n                && this.isTageschulenAnmeldungAktiv()) {\n                this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus.SCHULAMT_ANMELDUNG_ERFASST;\n                if (!this.anmeldungDTO.betreuung.belegungTagesschule) {\n                    this.anmeldungDTO.betreuung.belegungTagesschule = new TSBelegungTagesschule();\n                    // Default Eintrittsdatum ist erster Schultag, wenn noch in Zukunft\n                    let ersterSchultag: moment.Moment = this.gesuchModelManager.getGesuchsperiode().datumErsterSchultag;\n                    if (DateUtil.today().isBefore(ersterSchultag)) {\n                        this.anmeldungDTO.betreuung.belegungTagesschule.eintrittsdatum = ersterSchultag;\n                    }\n                }\n            } else {\n                // \"Alte\" Tagesschule: Noch keine Modulanmeldung moeglich. Wir setzen Default-Institution\n                this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus.SCHULAMT;\n\n            }\n            this.anmeldungDTO.betreuung.belegungFerieninsel = undefined;\n        } else {\n            if (!this.anmeldungDTO.betreuung.belegungFerieninsel) {\n                this.anmeldungDTO.betreuung.belegungFerieninsel = new TSBelegungFerieninsel();\n            }\n            this.anmeldungDTO.betreuung.belegungTagesschule = undefined;\n        }\n\n    }\n\n    public isTageschulenAnmeldungAktiv() {\n        return this.gesuchModelManager.getGesuchsperiode().isTageschulenAnmeldungAktiv();\n    }\n\n    public selectedKindChanged(): void {\n        if (this.kindContainer) {\n            this.anmeldungDTO.additionalKindQuestions = !this.kindContainer.kindJA.familienErgaenzendeBetreuung;\n            this.anmeldungDTO.kindContainerId = this.kindContainer.id;\n        }\n    }\n\n    public getDatumEinschulung(): moment.Moment {\n        return this.gesuchModelManager.getGesuchsperiodeBegin();\n    }\n\n    public anmeldenSchulamt(): void {\n        if (this.ts) {\n            this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus.SCHULAMT_ANMELDUNG_AUSGELOEST;\n\n            this.anmeldungDTO.betreuung.belegungTagesschule.moduleTagesschule = this.anmeldungDTO.betreuung.belegungTagesschule.moduleTagesschule\n                .filter(modul => modul.angemeldet === true);\n\n            this.betreuungRS.createAngebot(this.anmeldungDTO).then((response: any) => {\n                this.dvDialog.showDialog(okDialogTempl, OkDialogController, {\n                    title: 'TAGESSCHULE_ANMELDUNG_GESPEICHERT'\n                }).then(() => {\n                    this.backToHome();\n                });\n            }).catch(() => {\n                this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus.AUSSTEHEND;\n            });\n        } else if (this.fi) {\n            this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus.SCHULAMT_ANMELDUNG_AUSGELOEST;\n            this.betreuungRS.createAngebot(this.anmeldungDTO).then((response: any) => {\n                this.kindContainer.kindJA.familienErgaenzendeBetreuung = true;\n                this.dvDialog.showDialog(okDialogTempl, OkDialogController, {\n                    title: 'FERIENINSEL_ANMELDUNG_GESPEICHERT'\n                }).then(() => {\n                    this.backToHome();\n                });\n            }).catch(() => {\n                this.anmeldungDTO.betreuung.betreuungsstatus = TSBetreuungsstatus.AUSSTEHEND;\n            });\n\n        }\n    }\n\n    public backToHome() {\n        this.form.$setPristine();\n        this.$state.go('gesuchstellerDashboard');\n    }\n\n}\n"]}]}