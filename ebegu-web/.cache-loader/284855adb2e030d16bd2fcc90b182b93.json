{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/einkommensverschlechterungSteuernView/einkommensverschlechterungSteuernView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/einkommensverschlechterungSteuernView/einkommensverschlechterungSteuernView.ts","mtime":1512484412015},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["\"use strict\";\n/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar abstractGesuchView_1 = require(\"../abstractGesuchView\");\nvar TSWizardStepStatus_1 = require(\"../../../models/enums/TSWizardStepStatus\");\nvar TSFinanzModel_1 = require(\"../../../models/TSFinanzModel\");\nvar TSWizardStepName_1 = require(\"../../../models/enums/TSWizardStepName\");\nvar template = require('./einkommensverschlechterungSteuernView.html');\nrequire('./einkommensverschlechterungSteuernView.less');\nvar EinkommensverschlechterungSteuernViewComponentConfig = /** @class */ (function () {\n    function EinkommensverschlechterungSteuernViewComponentConfig() {\n        this.transclude = false;\n        this.template = template;\n        this.controller = EinkommensverschlechterungSteuernViewController;\n        this.controllerAs = 'vm';\n    }\n    return EinkommensverschlechterungSteuernViewComponentConfig;\n}());\nexports.EinkommensverschlechterungSteuernViewComponentConfig = EinkommensverschlechterungSteuernViewComponentConfig;\nvar EinkommensverschlechterungSteuernViewController = /** @class */ (function (_super) {\n    __extends(EinkommensverschlechterungSteuernViewController, _super);\n    /* @ngInject */\n    function EinkommensverschlechterungSteuernViewController(gesuchModelManager, berechnungsManager, errorService, wizardStepManager, $q, $scope, $timeout) {\n        var _this = _super.call(this, gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName_1.TSWizardStepName.EINKOMMENSVERSCHLECHTERUNG, $timeout) || this;\n        _this.errorService = errorService;\n        _this.$q = $q;\n        _this.model = new TSFinanzModel_1.default(_this.gesuchModelManager.getBasisjahr(), _this.gesuchModelManager.isGesuchsteller2Required(), null);\n        _this.model.copyEkvDataFromGesuch(_this.gesuchModelManager.getGesuch());\n        _this.initialModel = angular.copy(_this.model);\n        _this.allowedRoles = _this.TSRoleUtil.getAllRolesButTraegerschaftInstitution();\n        _this.initViewModel();\n        return _this;\n    }\n    EinkommensverschlechterungSteuernViewController.prototype.initViewModel = function () {\n        // Basis Jahr 1 braucht es nur wenn gewünscht\n        if (this.getEinkommensverschlechterungsInfo().ekvFuerBasisJahrPlus1) {\n            this.model.initEinkommensverschlechterungContainer(1, 1);\n            this.model.initEinkommensverschlechterungContainer(1, 2);\n        }\n        // Basis Jahr 2 braucht es nur wenn gewünscht\n        if (this.getEinkommensverschlechterungsInfo().ekvFuerBasisJahrPlus2) {\n            this.model.initEinkommensverschlechterungContainer(2, 1);\n            this.model.initEinkommensverschlechterungContainer(2, 2);\n        }\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.getEinkommensverschlechterungsInfo = function () {\n        return this.model.einkommensverschlechterungInfoContainer.einkommensverschlechterungInfoJA;\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.showSteuerveranlagung_BjP1 = function () {\n        return this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === true;\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.showSteuererklaerung_BjP1 = function () {\n        return this.isSteuerveranlagungErhaltenGS1_Bjp1() === false;\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.isSteuerveranlagungErhaltenGS1_Bjp1 = function () {\n        if (this.getEkv_GS1_Bjp1()) {\n            return this.getEkv_GS1_Bjp1().steuerveranlagungErhalten;\n        }\n        else {\n            return false;\n        }\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.save = function () {\n        var _this = this;\n        if (this.isGesuchValid()) {\n            if (!this.form.$dirty) {\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.gesuchModelManager.getGesuch());\n            }\n            this.removeNotNeededEKV();\n            this.errorService.clearAll();\n            this.model.copyEkvSitDataToGesuch(this.gesuchModelManager.getGesuch());\n            return this.gesuchModelManager.updateGesuch().then(function (gesuch) {\n                // Noetig, da nur das ganze Gesuch upgedated wird und die Aenderng bei der FinSit sonst nicht bemerkt werden\n                if (_this.gesuchModelManager.getGesuch().isMutation() && _this.wizardStepManager.getCurrentStep().wizardStepStatus !== TSWizardStepStatus_1.TSWizardStepStatus.NOK) {\n                    //wenn es NOK wir duerfen es erst im letzten Schritt aendern\n                    _this.wizardStepManager.updateCurrentWizardStepStatusMutiert();\n                }\n                return gesuch;\n            });\n        }\n        return undefined;\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.getEkv_GS1_Bjp1 = function () {\n        return this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1;\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.getEkv_GS2_Bjp1 = function () {\n        return this.model.einkommensverschlechterungContainerGS2.ekvJABasisJahrPlus1;\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.gemeinsameStekClicked_BjP1 = function () {\n        // Wenn neu NEIN -> Fragen loeschen\n        var ekvJaBasisJahrPlus1WasAlreadyEntered = this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1\n            && !this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1.isNew();\n        if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === false && ekvJaBasisJahrPlus1WasAlreadyEntered) {\n            // Wenn neu NEIN und schon was eingegeben -> Fragen mal auf false setzen und Status auf nok damit man sicher noch weiter muss!\n            this.initSteuerFragen();\n            this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus_1.TSWizardStepStatus.NOK);\n        }\n        else if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === false) {\n            // Wenn neu NEIN und noch nichts eingegeben -> Fragen loeschen da noch nichts eingegeben worden ist\n            this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1 = undefined;\n            this.model.einkommensverschlechterungContainerGS2.ekvJABasisJahrPlus1 = undefined;\n        }\n        else {\n            // Wenn neu JA\n            this.initViewModel(); //review @gapa fragen ist das nicht ein change genueber vorher\n        }\n    };\n    /**\n     * Es muss ein Wert geschrieben werden, um ekv persisierten zu können\n     */\n    EinkommensverschlechterungSteuernViewController.prototype.initSteuerFragen = function () {\n        var gs1EkvJABasisJahrPlus1 = this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1;\n        if (gs1EkvJABasisJahrPlus1) {\n            gs1EkvJABasisJahrPlus1.steuererklaerungAusgefuellt = !gs1EkvJABasisJahrPlus1.steuererklaerungAusgefuellt ? false : gs1EkvJABasisJahrPlus1.steuererklaerungAusgefuellt;\n            gs1EkvJABasisJahrPlus1.steuerveranlagungErhalten = !gs1EkvJABasisJahrPlus1.steuerveranlagungErhalten ? false : gs1EkvJABasisJahrPlus1.steuerveranlagungErhalten;\n        }\n        var gs2EkvJABasisJahrPlus1 = this.model.einkommensverschlechterungContainerGS2.ekvJABasisJahrPlus1;\n        if (gs2EkvJABasisJahrPlus1) {\n            gs2EkvJABasisJahrPlus1.steuererklaerungAusgefuellt = !gs2EkvJABasisJahrPlus1.steuererklaerungAusgefuellt ? false : gs2EkvJABasisJahrPlus1.steuererklaerungAusgefuellt;\n            gs2EkvJABasisJahrPlus1.steuerveranlagungErhalten = !gs2EkvJABasisJahrPlus1.steuerveranlagungErhalten ? false : gs2EkvJABasisJahrPlus1.steuerveranlagungErhalten;\n        }\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.removeNotNeededEKV = function () {\n        if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === false) {\n            this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1 = undefined;\n            this.model.einkommensverschlechterungContainerGS2.ekvJABasisJahrPlus1 = undefined;\n        }\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.steuerveranlagungClicked_BjP1 = function () {\n        // Wenn Steuerveranlagung JA -> auch StekErhalten -> JA\n        // Wenn zusätzlich noch GemeinsameStek -> Dasselbe auch für GS2\n        // Wenn Steuerveranlagung erhalten, muss auch STEK ausgefüllt worden sein\n        if (this.getEkv_GS1_Bjp1().steuerveranlagungErhalten === true) {\n            this.getEkv_GS1_Bjp1().steuererklaerungAusgefuellt = true;\n            if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === true) {\n                this.getEkv_GS2_Bjp1().steuerveranlagungErhalten = true;\n                this.getEkv_GS2_Bjp1().steuererklaerungAusgefuellt = true;\n            }\n        }\n        else if (this.getEkv_GS1_Bjp1().steuerveranlagungErhalten === false) {\n            // Steuerveranlagung neu NEIN -> Fragen loeschen\n            this.getEkv_GS1_Bjp1().steuererklaerungAusgefuellt = undefined;\n            if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === true) {\n                this.getEkv_GS2_Bjp1().steuerveranlagungErhalten = false;\n                this.getEkv_GS2_Bjp1().steuererklaerungAusgefuellt = undefined;\n            }\n        }\n    };\n    EinkommensverschlechterungSteuernViewController.prototype.steuererklaerungClicked_BjP1 = function () {\n        if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === true) {\n            this.getEkv_GS2_Bjp1().steuererklaerungAusgefuellt = this.getEkv_GS1_Bjp1().steuererklaerungAusgefuellt;\n        }\n    };\n    EinkommensverschlechterungSteuernViewController.$inject = ['GesuchModelManager', 'BerechnungsManager', 'ErrorService',\n        'WizardStepManager', '$q', '$scope', '$timeout'];\n    return EinkommensverschlechterungSteuernViewController;\n}(abstractGesuchView_1.default));\nexports.EinkommensverschlechterungSteuernViewController = EinkommensverschlechterungSteuernViewController;\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/einkommensverschlechterungSteuernView/einkommensverschlechterungSteuernView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/einkommensverschlechterungSteuernView/einkommensverschlechterungSteuernView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {IComponentOptions, IPromise} from 'angular';\nimport AbstractGesuchViewController from '../abstractGesuchView';\nimport GesuchModelManager from '../../service/gesuchModelManager';\nimport TSEinkommensverschlechterung from '../../../models/TSEinkommensverschlechterung';\nimport BerechnungsManager from '../../service/berechnungsManager';\nimport ErrorService from '../../../core/errors/service/ErrorService';\nimport TSEinkommensverschlechterungInfo from '../../../models/TSEinkommensverschlechterungInfo';\nimport TSGesuch from '../../../models/TSGesuch';\nimport WizardStepManager from '../../service/wizardStepManager';\nimport {TSRole} from '../../../models/enums/TSRole';\nimport {TSWizardStepStatus} from '../../../models/enums/TSWizardStepStatus';\nimport TSFinanzModel from '../../../models/TSFinanzModel';\nimport {TSWizardStepName} from '../../../models/enums/TSWizardStepName';\nimport IQService = angular.IQService;\nimport IScope = angular.IScope;\nimport ITimeoutService = angular.ITimeoutService;\n\nlet template = require('./einkommensverschlechterungSteuernView.html');\nrequire('./einkommensverschlechterungSteuernView.less');\n\nexport class EinkommensverschlechterungSteuernViewComponentConfig implements IComponentOptions {\n    transclude = false;\n    template = template;\n    controller = EinkommensverschlechterungSteuernViewController;\n    controllerAs = 'vm';\n}\n\nexport class EinkommensverschlechterungSteuernViewController extends AbstractGesuchViewController<TSFinanzModel> {\n\n    allowedRoles: Array<TSRole>;\n    initialModel: TSFinanzModel;\n\n    static $inject: string[] = ['GesuchModelManager', 'BerechnungsManager', 'ErrorService',\n        'WizardStepManager', '$q', '$scope', '$timeout'];\n\n    /* @ngInject */\n    constructor(gesuchModelManager: GesuchModelManager, berechnungsManager: BerechnungsManager,\n                private errorService: ErrorService, wizardStepManager: WizardStepManager,\n                private $q: IQService, $scope: IScope, $timeout: ITimeoutService) {\n        super(gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName.EINKOMMENSVERSCHLECHTERUNG, $timeout);\n        this.model = new TSFinanzModel(this.gesuchModelManager.getBasisjahr(), this.gesuchModelManager.isGesuchsteller2Required(), null);\n        this.model.copyEkvDataFromGesuch(this.gesuchModelManager.getGesuch());\n        this.initialModel = angular.copy(this.model);\n\n        this.allowedRoles = this.TSRoleUtil.getAllRolesButTraegerschaftInstitution();\n        this.initViewModel();\n    }\n\n    private initViewModel() {\n        // Basis Jahr 1 braucht es nur wenn gewünscht\n        if (this.getEinkommensverschlechterungsInfo().ekvFuerBasisJahrPlus1) {\n            this.model.initEinkommensverschlechterungContainer(1, 1);\n            this.model.initEinkommensverschlechterungContainer(1, 2);\n        }\n\n        // Basis Jahr 2 braucht es nur wenn gewünscht\n        if (this.getEinkommensverschlechterungsInfo().ekvFuerBasisJahrPlus2) {\n            this.model.initEinkommensverschlechterungContainer(2, 1);\n            this.model.initEinkommensverschlechterungContainer(2, 2);\n        }\n    }\n\n    getEinkommensverschlechterungsInfo(): TSEinkommensverschlechterungInfo {\n        return this.model.einkommensverschlechterungInfoContainer.einkommensverschlechterungInfoJA;\n    }\n\n    showSteuerveranlagung_BjP1(): boolean {\n        return this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === true;\n    }\n\n    showSteuererklaerung_BjP1(): boolean {\n        return this.isSteuerveranlagungErhaltenGS1_Bjp1() === false;\n    }\n\n    isSteuerveranlagungErhaltenGS1_Bjp1(): boolean {\n        if (this.getEkv_GS1_Bjp1()) {\n            return this.getEkv_GS1_Bjp1().steuerveranlagungErhalten;\n        } else {\n            return false;\n        }\n    }\n\n    private save(): IPromise<TSGesuch> {\n        if (this.isGesuchValid()) {\n            if (!this.form.$dirty) {\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.gesuchModelManager.getGesuch());\n            }\n            this.removeNotNeededEKV();\n            this.errorService.clearAll();\n            this.model.copyEkvSitDataToGesuch(this.gesuchModelManager.getGesuch());\n            return this.gesuchModelManager.updateGesuch().then((gesuch: TSGesuch) => {\n                // Noetig, da nur das ganze Gesuch upgedated wird und die Aenderng bei der FinSit sonst nicht bemerkt werden\n                if (this.gesuchModelManager.getGesuch().isMutation() && this.wizardStepManager.getCurrentStep().wizardStepStatus !== TSWizardStepStatus.NOK) {\n                    //wenn es NOK wir duerfen es erst im letzten Schritt aendern\n                    this.wizardStepManager.updateCurrentWizardStepStatusMutiert();\n                }\n                return gesuch;\n            });\n        }\n        return undefined;\n    }\n\n    public getEkv_GS1_Bjp1(): TSEinkommensverschlechterung {\n        return this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1;\n    }\n\n    public getEkv_GS2_Bjp1(): TSEinkommensverschlechterung {\n        return this.model.einkommensverschlechterungContainerGS2.ekvJABasisJahrPlus1;\n    }\n\n    private gemeinsameStekClicked_BjP1(): void {\n        // Wenn neu NEIN -> Fragen loeschen\n\n        let ekvJaBasisJahrPlus1WasAlreadyEntered = this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1\n            && !this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1.isNew();\n        if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === false && ekvJaBasisJahrPlus1WasAlreadyEntered) {\n            // Wenn neu NEIN und schon was eingegeben -> Fragen mal auf false setzen und Status auf nok damit man sicher noch weiter muss!\n            this.initSteuerFragen();\n            this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus.NOK);\n        } else if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === false) {\n            // Wenn neu NEIN und noch nichts eingegeben -> Fragen loeschen da noch nichts eingegeben worden ist\n            this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1 = undefined;\n            this.model.einkommensverschlechterungContainerGS2.ekvJABasisJahrPlus1 = undefined;\n        } else {\n            // Wenn neu JA\n            this.initViewModel();  //review @gapa fragen ist das nicht ein change genueber vorher\n        }\n    }\n\n    /**\n     * Es muss ein Wert geschrieben werden, um ekv persisierten zu können\n     */\n    private initSteuerFragen() {\n        let gs1EkvJABasisJahrPlus1 = this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1;\n        if (gs1EkvJABasisJahrPlus1) {\n            gs1EkvJABasisJahrPlus1.steuererklaerungAusgefuellt = !gs1EkvJABasisJahrPlus1.steuererklaerungAusgefuellt ? false : gs1EkvJABasisJahrPlus1.steuererklaerungAusgefuellt;\n            gs1EkvJABasisJahrPlus1.steuerveranlagungErhalten = !gs1EkvJABasisJahrPlus1.steuerveranlagungErhalten ? false : gs1EkvJABasisJahrPlus1.steuerveranlagungErhalten;\n        }\n        let gs2EkvJABasisJahrPlus1 = this.model.einkommensverschlechterungContainerGS2.ekvJABasisJahrPlus1;\n        if (gs2EkvJABasisJahrPlus1) {\n            gs2EkvJABasisJahrPlus1.steuererklaerungAusgefuellt = !gs2EkvJABasisJahrPlus1.steuererklaerungAusgefuellt ? false : gs2EkvJABasisJahrPlus1.steuererklaerungAusgefuellt;\n            gs2EkvJABasisJahrPlus1.steuerveranlagungErhalten = !gs2EkvJABasisJahrPlus1.steuerveranlagungErhalten ? false : gs2EkvJABasisJahrPlus1.steuerveranlagungErhalten;\n        }\n    }\n\n    private removeNotNeededEKV(): void {\n\n        if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === false) {\n            this.model.einkommensverschlechterungContainerGS1.ekvJABasisJahrPlus1 = undefined;\n            this.model.einkommensverschlechterungContainerGS2.ekvJABasisJahrPlus1 = undefined;\n        }\n    }\n\n    private steuerveranlagungClicked_BjP1(): void {\n        // Wenn Steuerveranlagung JA -> auch StekErhalten -> JA\n        // Wenn zusätzlich noch GemeinsameStek -> Dasselbe auch für GS2\n        // Wenn Steuerveranlagung erhalten, muss auch STEK ausgefüllt worden sein\n        if (this.getEkv_GS1_Bjp1().steuerveranlagungErhalten === true) {\n            this.getEkv_GS1_Bjp1().steuererklaerungAusgefuellt = true;\n            if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === true) {\n                this.getEkv_GS2_Bjp1().steuerveranlagungErhalten = true;\n                this.getEkv_GS2_Bjp1().steuererklaerungAusgefuellt = true;\n            }\n        } else if (this.getEkv_GS1_Bjp1().steuerveranlagungErhalten === false) {\n            // Steuerveranlagung neu NEIN -> Fragen loeschen\n            this.getEkv_GS1_Bjp1().steuererklaerungAusgefuellt = undefined;\n            if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === true) {\n                this.getEkv_GS2_Bjp1().steuerveranlagungErhalten = false;\n                this.getEkv_GS2_Bjp1().steuererklaerungAusgefuellt = undefined;\n            }\n        }\n    }\n\n    private steuererklaerungClicked_BjP1() {\n        if (this.getEinkommensverschlechterungsInfo().gemeinsameSteuererklaerung_BjP1 === true) {\n            this.getEkv_GS2_Bjp1().steuererklaerungAusgefuellt = this.getEkv_GS1_Bjp1().steuererklaerungAusgefuellt;\n        }\n    }\n\n}\n"]}]}