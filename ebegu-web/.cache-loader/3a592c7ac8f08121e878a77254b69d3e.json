{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/einkommensverschlechterungView/einkommensverschlechterungView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/einkommensverschlechterungView/einkommensverschlechterungView.ts","mtime":1512484412015},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["\"use strict\";\n/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar abstractGesuchView_1 = require(\"../abstractGesuchView\");\nvar TSFinanzModel_1 = require(\"../../../models/TSFinanzModel\");\nvar TSWizardStepName_1 = require(\"../../../models/enums/TSWizardStepName\");\nvar template = require('./einkommensverschlechterungView.html');\nrequire('./einkommensverschlechterungView.less');\nvar EinkommensverschlechterungViewComponentConfig = /** @class */ (function () {\n    function EinkommensverschlechterungViewComponentConfig() {\n        this.transclude = false;\n        this.template = template;\n        this.controller = EinkommensverschlechterungViewController;\n        this.controllerAs = 'vm';\n    }\n    return EinkommensverschlechterungViewComponentConfig;\n}());\nexports.EinkommensverschlechterungViewComponentConfig = EinkommensverschlechterungViewComponentConfig;\nvar EinkommensverschlechterungViewController = /** @class */ (function (_super) {\n    __extends(EinkommensverschlechterungViewController, _super);\n    /* @ngInject */\n    function EinkommensverschlechterungViewController($stateParams, gesuchModelManager, berechnungsManager, errorService, $log, wizardStepManager, $q, $scope, $translate, $timeout) {\n        var _this = _super.call(this, gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName_1.TSWizardStepName.EINKOMMENSVERSCHLECHTERUNG, $timeout) || this;\n        _this.errorService = errorService;\n        _this.$log = $log;\n        _this.$q = $q;\n        _this.$translate = $translate;\n        var parsedGesuchstelllerNum = parseInt($stateParams.gesuchstellerNumber, 10);\n        var parsedBasisJahrPlusNum = parseInt($stateParams.basisjahrPlus, 10);\n        _this.gesuchModelManager.setGesuchstellerNumber(parsedGesuchstelllerNum);\n        _this.gesuchModelManager.setBasisJahrPlusNumber(parsedBasisJahrPlusNum);\n        _this.model = new TSFinanzModel_1.default(_this.gesuchModelManager.getBasisjahr(), _this.gesuchModelManager.isGesuchsteller2Required(), parsedGesuchstelllerNum, parsedBasisJahrPlusNum);\n        _this.model.copyEkvDataFromGesuch(_this.gesuchModelManager.getGesuch());\n        _this.model.copyFinSitDataFromGesuch(_this.gesuchModelManager.getGesuch());\n        _this.model.initEinkommensverschlechterungContainer(parsedBasisJahrPlusNum, parsedGesuchstelllerNum);\n        _this.initialModel = angular.copy(_this.model);\n        _this.allowedRoles = _this.TSRoleUtil.getAllRolesButTraegerschaftInstitution();\n        _this.initViewModel();\n        _this.calculate();\n        return _this;\n    }\n    EinkommensverschlechterungViewController.prototype.initViewModel = function () {\n        this.initGeschaeftsgewinnFromFS();\n        this.showSelbstaendig = this.model.getFiSiConToWorkWith().finanzielleSituationJA.isSelbstaendig()\n            || (this.model.getEkvToWorkWith().geschaeftsgewinnBasisjahr !== null\n                && this.model.getEkvToWorkWith().geschaeftsgewinnBasisjahr !== undefined);\n        if (this.model.getFiSiConToWorkWith().finanzielleSituationGS && this.model.getEkvToWorkWith_GS()) {\n            this.showSelbstaendigGS = this.model.getFiSiConToWorkWith().finanzielleSituationGS.isSelbstaendig()\n                || (this.model.getEkvToWorkWith_GS().geschaeftsgewinnBasisjahr !== null\n                    && this.model.getEkvToWorkWith_GS().geschaeftsgewinnBasisjahr !== undefined);\n        }\n    };\n    EinkommensverschlechterungViewController.prototype.showSelbstaendigClicked = function () {\n        if (!this.showSelbstaendig) {\n            this.resetSelbstaendigFields();\n        }\n    };\n    EinkommensverschlechterungViewController.prototype.resetSelbstaendigFields = function () {\n        if (this.model.getEkvToWorkWith().geschaeftsgewinnBasisjahr) {\n            this.model.getEkvToWorkWith().geschaeftsgewinnBasisjahr = undefined;\n            this.calculate();\n        }\n    };\n    /**\n     *  Wenn z.B. in der Periode 2016/2017 eine Einkommensverschlechterung für 2017 geltend gemacht wird,\n     *  ist es unmöglich, dass die Steuerveranlagung und Steuererklärung für 2017 schon dem Gesuchsteller vorliegt\n     */\n    EinkommensverschlechterungViewController.prototype.showSteuerveranlagung = function () {\n        return (this.model.getBasisJahrPlus() === 1) &&\n            (!this.model.getGemeinsameSteuererklaerungToWorkWith() || this.model.getGemeinsameSteuererklaerungToWorkWith() === false);\n    };\n    EinkommensverschlechterungViewController.prototype.showSteuererklaerung = function () {\n        return this.model.getEkvToWorkWith().steuerveranlagungErhalten === false;\n    };\n    EinkommensverschlechterungViewController.prototype.showHintSteuererklaerung = function () {\n        return this.model.getEkvToWorkWith().steuererklaerungAusgefuellt === true &&\n            this.model.getEkvToWorkWith().steuerveranlagungErhalten === false;\n    };\n    EinkommensverschlechterungViewController.prototype.showHintSteuerveranlagung = function () {\n        return this.model.getEkvToWorkWith().steuerveranlagungErhalten === true;\n    };\n    EinkommensverschlechterungViewController.prototype.steuerveranlagungClicked = function () {\n        // Wenn Steuerveranlagung JA -> auch StekErhalten -> JA\n        if (this.model.getEkvToWorkWith().steuerveranlagungErhalten === true) {\n            this.model.getEkvToWorkWith().steuererklaerungAusgefuellt = true;\n        }\n        else if (this.model.getEkvToWorkWith().steuerveranlagungErhalten === false) {\n            // Steuerveranlagung neu NEIN -> Fragen loeschen\n            this.model.getEkvToWorkWith().steuererklaerungAusgefuellt = undefined;\n        }\n    };\n    EinkommensverschlechterungViewController.prototype.save = function () {\n        if (this.isGesuchValid()) {\n            if (!this.form.$dirty) {\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.model.getEkvContToWorkWith());\n            }\n            this.errorService.clearAll();\n            this.model.copyEkvSitDataToGesuch(this.gesuchModelManager.getGesuch());\n            return this.gesuchModelManager.saveEinkommensverschlechterungContainer();\n        }\n        return undefined;\n    };\n    EinkommensverschlechterungViewController.prototype.calculate = function () {\n        this.berechnungsManager.calculateEinkommensverschlechterungTemp(this.model, this.model.getBasisJahrPlus());\n    };\n    EinkommensverschlechterungViewController.prototype.getEinkommensverschlechterung = function () {\n        return this.model.getEkvToWorkWith();\n    };\n    EinkommensverschlechterungViewController.prototype.getResultate = function () {\n        return this.berechnungsManager.getEinkommensverschlechterungResultate(this.model.getBasisJahrPlus());\n    };\n    EinkommensverschlechterungViewController.prototype.initGeschaeftsgewinnFromFS = function () {\n        if (!this.model.getFiSiConToWorkWith()\n            || !this.model.getFiSiConToWorkWith().finanzielleSituationJA) {\n            this.$log.error('Fehler: FinSit muss existieren');\n            return;\n        }\n        var fs = this.model.getFiSiConToWorkWith().finanzielleSituationJA;\n        var fsGS = this.model.getFiSiConToWorkWith().finanzielleSituationGS;\n        if (this.model.getBasisJahrPlus() === 2) {\n            //basisjahr Plus 2\n            if (this.model.einkommensverschlechterungInfoContainer.einkommensverschlechterungInfoJA.ekvFuerBasisJahrPlus1) {\n                var einkommensverschlJABasisjahrPlus1 = this.model.getEkvContToWorkWith().ekvJABasisJahrPlus1;\n                this.geschaeftsgewinnBasisjahrMinus1 = einkommensverschlJABasisjahrPlus1 ? einkommensverschlJABasisjahrPlus1.geschaeftsgewinnBasisjahr : undefined;\n                var einkommensverschlGSBasisjahrPlus1 = this.model.getEkvContToWorkWith().ekvGSBasisJahrPlus1;\n                this.geschaeftsgewinnBasisjahrMinus1GS = einkommensverschlGSBasisjahrPlus1 ? einkommensverschlGSBasisjahrPlus1.geschaeftsgewinnBasisjahr : undefined;\n            }\n            else {\n                var einkommensverschlGS = this.model.getEkvToWorkWith_GS();\n                this.geschaeftsgewinnBasisjahrMinus1GS = einkommensverschlGS ? einkommensverschlGS.geschaeftsgewinnBasisjahrMinus1 : undefined;\n            }\n            this.geschaeftsgewinnBasisjahrMinus2 = fs.geschaeftsgewinnBasisjahr;\n            this.geschaeftsgewinnBasisjahrMinus2GS = fsGS ? fsGS.geschaeftsgewinnBasisjahr : undefined;\n        }\n        else {\n            this.geschaeftsgewinnBasisjahrMinus1 = fs.geschaeftsgewinnBasisjahr;\n            this.geschaeftsgewinnBasisjahrMinus2 = fs.geschaeftsgewinnBasisjahrMinus1;\n            this.geschaeftsgewinnBasisjahrMinus1GS = fsGS ? fsGS.geschaeftsgewinnBasisjahr : undefined;\n            this.geschaeftsgewinnBasisjahrMinus2GS = fsGS ? fsGS.geschaeftsgewinnBasisjahrMinus1 : undefined;\n        }\n    };\n    EinkommensverschlechterungViewController.prototype.enableGeschaeftsgewinnBasisjahrMinus1 = function () {\n        return this.model.getBasisJahrPlus() === 2 && !this.model.einkommensverschlechterungInfoContainer.einkommensverschlechterungInfoJA.ekvFuerBasisJahrPlus1;\n    };\n    EinkommensverschlechterungViewController.prototype.getTextSelbstaendigKorrektur = function () {\n        if (this.showSelbstaendigGS === true && this.model.getEkvToWorkWith_GS()) {\n            var gew1 = this.model.getEkvToWorkWith_GS().geschaeftsgewinnBasisjahr;\n            if (gew1) {\n                var basisjahr = this.gesuchModelManager.getBasisjahrPlus(this.model.getBasisJahrPlus());\n                return this.$translate.instant('JA_KORREKTUR_SELBSTAENDIG_EKV', { basisjahr: basisjahr, gewinn1: gew1 });\n            }\n        }\n        return this.$translate.instant('LABEL_KEINE_ANGABE');\n    };\n    EinkommensverschlechterungViewController.$inject = ['$stateParams', 'GesuchModelManager', 'BerechnungsManager', 'ErrorService', '$log',\n        'WizardStepManager', '$q', '$scope', '$translate', '$timeout'];\n    return EinkommensverschlechterungViewController;\n}(abstractGesuchView_1.default));\nexports.EinkommensverschlechterungViewController = EinkommensverschlechterungViewController;\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/einkommensverschlechterungView/einkommensverschlechterungView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/einkommensverschlechterungView/einkommensverschlechterungView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {IComponentOptions, ILogService, IPromise, IQService} from 'angular';\nimport AbstractGesuchViewController from '../abstractGesuchView';\nimport GesuchModelManager from '../../service/gesuchModelManager';\nimport {IEinkommensverschlechterungStateParams} from '../../gesuch.route';\nimport BerechnungsManager from '../../service/berechnungsManager';\nimport TSFinanzielleSituationResultateDTO from '../../../models/dto/TSFinanzielleSituationResultateDTO';\nimport ErrorService from '../../../core/errors/service/ErrorService';\nimport TSEinkommensverschlechterung from '../../../models/TSEinkommensverschlechterung';\nimport TSFinanzielleSituation from '../../../models/TSFinanzielleSituation';\nimport WizardStepManager from '../../service/wizardStepManager';\nimport TSEinkommensverschlechterungContainer from '../../../models/TSEinkommensverschlechterungContainer';\nimport {TSRole} from '../../../models/enums/TSRole';\nimport TSFinanzModel from '../../../models/TSFinanzModel';\nimport {TSWizardStepName} from '../../../models/enums/TSWizardStepName';\nimport IScope = angular.IScope;\nimport ITranslateService = angular.translate.ITranslateService;\nimport ITimeoutService = angular.ITimeoutService;\n\nlet template = require('./einkommensverschlechterungView.html');\nrequire('./einkommensverschlechterungView.less');\n\nexport class EinkommensverschlechterungViewComponentConfig implements IComponentOptions {\n    transclude = false;\n    template = template;\n    controller = EinkommensverschlechterungViewController;\n    controllerAs = 'vm';\n}\n\nexport class EinkommensverschlechterungViewController extends AbstractGesuchViewController<TSFinanzModel> {\n\n    public showSelbstaendig: boolean;\n    public showSelbstaendigGS: boolean;\n    public geschaeftsgewinnBasisjahrMinus1: number;\n    public geschaeftsgewinnBasisjahrMinus2: number;\n    public geschaeftsgewinnBasisjahrMinus1GS: number;\n    public geschaeftsgewinnBasisjahrMinus2GS: number;\n    allowedRoles: Array<TSRole>;\n    public initialModel: TSFinanzModel;\n\n    static $inject: string[] = ['$stateParams', 'GesuchModelManager', 'BerechnungsManager', 'ErrorService', '$log',\n        'WizardStepManager', '$q', '$scope', '$translate', '$timeout'];\n\n    /* @ngInject */\n    constructor($stateParams: IEinkommensverschlechterungStateParams, gesuchModelManager: GesuchModelManager,\n                berechnungsManager: BerechnungsManager, private errorService: ErrorService, private $log: ILogService,\n                wizardStepManager: WizardStepManager, private $q: IQService, $scope: IScope, private $translate: ITranslateService,\n                $timeout: ITimeoutService) {\n        super(gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName.EINKOMMENSVERSCHLECHTERUNG, $timeout);\n        let parsedGesuchstelllerNum: number = parseInt($stateParams.gesuchstellerNumber, 10);\n        let parsedBasisJahrPlusNum: number = parseInt($stateParams.basisjahrPlus, 10);\n        this.gesuchModelManager.setGesuchstellerNumber(parsedGesuchstelllerNum);\n        this.gesuchModelManager.setBasisJahrPlusNumber(parsedBasisJahrPlusNum);\n        this.model = new TSFinanzModel(this.gesuchModelManager.getBasisjahr(), this.gesuchModelManager.isGesuchsteller2Required(), parsedGesuchstelllerNum, parsedBasisJahrPlusNum);\n        this.model.copyEkvDataFromGesuch(this.gesuchModelManager.getGesuch());\n        this.model.copyFinSitDataFromGesuch(this.gesuchModelManager.getGesuch());\n        this.model.initEinkommensverschlechterungContainer(parsedBasisJahrPlusNum, parsedGesuchstelllerNum);\n        this.initialModel = angular.copy(this.model);\n        this.allowedRoles = this.TSRoleUtil.getAllRolesButTraegerschaftInstitution();\n        this.initViewModel();\n        this.calculate();\n\n    }\n\n    private initViewModel() {\n        this.initGeschaeftsgewinnFromFS();\n        this.showSelbstaendig = this.model.getFiSiConToWorkWith().finanzielleSituationJA.isSelbstaendig()\n            || (this.model.getEkvToWorkWith().geschaeftsgewinnBasisjahr !== null\n                && this.model.getEkvToWorkWith().geschaeftsgewinnBasisjahr !== undefined);\n        if (this.model.getFiSiConToWorkWith().finanzielleSituationGS && this.model.getEkvToWorkWith_GS()) {\n            this.showSelbstaendigGS = this.model.getFiSiConToWorkWith().finanzielleSituationGS.isSelbstaendig()\n                || (this.model.getEkvToWorkWith_GS().geschaeftsgewinnBasisjahr !== null\n                    && this.model.getEkvToWorkWith_GS().geschaeftsgewinnBasisjahr !== undefined);\n        }\n    }\n\n    public showSelbstaendigClicked() {\n        if (!this.showSelbstaendig) {\n            this.resetSelbstaendigFields();\n        }\n    }\n\n    private resetSelbstaendigFields() {\n        if (this.model.getEkvToWorkWith().geschaeftsgewinnBasisjahr) {\n            this.model.getEkvToWorkWith().geschaeftsgewinnBasisjahr = undefined;\n            this.calculate();\n        }\n    }\n\n    /**\n     *  Wenn z.B. in der Periode 2016/2017 eine Einkommensverschlechterung für 2017 geltend gemacht wird,\n     *  ist es unmöglich, dass die Steuerveranlagung und Steuererklärung für 2017 schon dem Gesuchsteller vorliegt\n     */\n    showSteuerveranlagung(): boolean {\n        return (this.model.getBasisJahrPlus() === 1) &&\n            (!this.model.getGemeinsameSteuererklaerungToWorkWith() || this.model.getGemeinsameSteuererklaerungToWorkWith() === false);\n    }\n\n    showSteuererklaerung(): boolean {\n        return this.model.getEkvToWorkWith().steuerveranlagungErhalten === false;\n    }\n\n    showHintSteuererklaerung(): boolean {\n        return this.model.getEkvToWorkWith().steuererklaerungAusgefuellt === true &&\n            this.model.getEkvToWorkWith().steuerveranlagungErhalten === false;\n    }\n\n    showHintSteuerveranlagung(): boolean {\n        return this.model.getEkvToWorkWith().steuerveranlagungErhalten === true;\n    }\n\n    steuerveranlagungClicked(): void {\n        // Wenn Steuerveranlagung JA -> auch StekErhalten -> JA\n        if (this.model.getEkvToWorkWith().steuerveranlagungErhalten === true) {\n            this.model.getEkvToWorkWith().steuererklaerungAusgefuellt = true;\n        } else if (this.model.getEkvToWorkWith().steuerveranlagungErhalten === false) {\n            // Steuerveranlagung neu NEIN -> Fragen loeschen\n            this.model.getEkvToWorkWith().steuererklaerungAusgefuellt = undefined;\n        }\n    }\n\n    private save(): IPromise<TSEinkommensverschlechterungContainer> {\n        if (this.isGesuchValid()) {\n            if (!this.form.$dirty) {\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.model.getEkvContToWorkWith());\n            }\n            this.errorService.clearAll();\n            this.model.copyEkvSitDataToGesuch(this.gesuchModelManager.getGesuch());\n            return this.gesuchModelManager.saveEinkommensverschlechterungContainer();\n        }\n        return undefined;\n    }\n\n    calculate() {\n        this.berechnungsManager.calculateEinkommensverschlechterungTemp(this.model, this.model.getBasisJahrPlus());\n    }\n\n    public getEinkommensverschlechterung(): TSEinkommensverschlechterung {\n        return this.model.getEkvToWorkWith();\n    }\n\n    public getResultate(): TSFinanzielleSituationResultateDTO {\n        return this.berechnungsManager.getEinkommensverschlechterungResultate(this.model.getBasisJahrPlus());\n    }\n\n    public initGeschaeftsgewinnFromFS(): void {\n        if (!this.model.getFiSiConToWorkWith()\n            || !this.model.getFiSiConToWorkWith().finanzielleSituationJA) {\n            this.$log.error('Fehler: FinSit muss existieren');\n            return;\n        }\n\n        let fs: TSFinanzielleSituation = this.model.getFiSiConToWorkWith().finanzielleSituationJA;\n        let fsGS: TSFinanzielleSituation = this.model.getFiSiConToWorkWith().finanzielleSituationGS;\n        if (this.model.getBasisJahrPlus() === 2) {\n            //basisjahr Plus 2\n            if (this.model.einkommensverschlechterungInfoContainer.einkommensverschlechterungInfoJA.ekvFuerBasisJahrPlus1) {\n                let einkommensverschlJABasisjahrPlus1 = this.model.getEkvContToWorkWith().ekvJABasisJahrPlus1;\n                this.geschaeftsgewinnBasisjahrMinus1 = einkommensverschlJABasisjahrPlus1 ? einkommensverschlJABasisjahrPlus1.geschaeftsgewinnBasisjahr : undefined;\n                let einkommensverschlGSBasisjahrPlus1 = this.model.getEkvContToWorkWith().ekvGSBasisJahrPlus1;\n                this.geschaeftsgewinnBasisjahrMinus1GS = einkommensverschlGSBasisjahrPlus1 ? einkommensverschlGSBasisjahrPlus1.geschaeftsgewinnBasisjahr : undefined;\n            } else {\n                let einkommensverschlGS = this.model.getEkvToWorkWith_GS();\n                this.geschaeftsgewinnBasisjahrMinus1GS = einkommensverschlGS ? einkommensverschlGS.geschaeftsgewinnBasisjahrMinus1 : undefined;\n            }\n\n            this.geschaeftsgewinnBasisjahrMinus2 = fs.geschaeftsgewinnBasisjahr;\n            this.geschaeftsgewinnBasisjahrMinus2GS = fsGS ? fsGS.geschaeftsgewinnBasisjahr : undefined;\n        } else {\n            this.geschaeftsgewinnBasisjahrMinus1 = fs.geschaeftsgewinnBasisjahr;\n            this.geschaeftsgewinnBasisjahrMinus2 = fs.geschaeftsgewinnBasisjahrMinus1;\n            this.geschaeftsgewinnBasisjahrMinus1GS = fsGS ? fsGS.geschaeftsgewinnBasisjahr : undefined;\n            this.geschaeftsgewinnBasisjahrMinus2GS = fsGS ? fsGS.geschaeftsgewinnBasisjahrMinus1 : undefined;\n        }\n    }\n\n    public enableGeschaeftsgewinnBasisjahrMinus1(): boolean {\n        return this.model.getBasisJahrPlus() === 2 && !this.model.einkommensverschlechterungInfoContainer.einkommensverschlechterungInfoJA.ekvFuerBasisJahrPlus1;\n    }\n\n    public getTextSelbstaendigKorrektur() {\n        if (this.showSelbstaendigGS === true && this.model.getEkvToWorkWith_GS()) {\n            let gew1 = this.model.getEkvToWorkWith_GS().geschaeftsgewinnBasisjahr;\n            if (gew1) {\n                let basisjahr = this.gesuchModelManager.getBasisjahrPlus(this.model.getBasisJahrPlus());\n                return this.$translate.instant('JA_KORREKTUR_SELBSTAENDIG_EKV',\n                    {basisjahr: basisjahr, gewinn1: gew1});\n            }\n        }\n        return this.$translate.instant('LABEL_KEINE_ANGABE');\n    }\n}\n"]}]}