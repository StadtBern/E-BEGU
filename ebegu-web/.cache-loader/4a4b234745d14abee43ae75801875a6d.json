{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/freigabeView/freigabeView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/freigabeView/freigabeView.ts","mtime":1518535855228},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\ndefine([\"require\", \"exports\", \"../abstractGesuchView\", \"../../../models/enums/TSWizardStepName\", \"../../../models/enums/TSWizardStepStatus\", \"../../../models/enums/TSAntragStatus\", \"../../../utils/DateUtil\", \"../../../models/enums/TSZustelladresse\", \"../../dialog/FreigabeDialogController\", \"../../../utils/TSRoleUtil\", \"../../../utils/EbeguUtil\"], function (require, exports, abstractGesuchView_1, TSWizardStepName_1, TSWizardStepStatus_1, TSAntragStatus_1, DateUtil_1, TSZustelladresse_1, FreigabeDialogController_1, TSRoleUtil_1, EbeguUtil_1) {\n    \"use strict\";\n    Object.defineProperty(exports, \"__esModule\", { value: true });\n    var template = require('./freigabeView.html');\n    require('./freigabeView.less');\n    var dialogTemplate = require('../../dialog/removeDialogTemplate.html');\n    var FreigabeViewComponentConfig = /** @class */ (function () {\n        function FreigabeViewComponentConfig() {\n            this.transclude = false;\n            this.bindings = {};\n            this.template = template;\n            this.controller = FreigabeViewController;\n            this.controllerAs = 'vm';\n        }\n        return FreigabeViewComponentConfig;\n    }());\n    exports.FreigabeViewComponentConfig = FreigabeViewComponentConfig;\n    var FreigabeViewController = /** @class */ (function (_super) {\n        __extends(FreigabeViewController, _super);\n        /* @ngInject */\n        function FreigabeViewController(gesuchModelManager, berechnungsManager, wizardStepManager, DvDialog, downloadRS, $scope, applicationPropertyRS, authServiceRS, $timeout) {\n            var _this = _super.call(this, gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName_1.TSWizardStepName.FREIGABE, $timeout) || this;\n            _this.DvDialog = DvDialog;\n            _this.downloadRS = downloadRS;\n            _this.applicationPropertyRS = applicationPropertyRS;\n            _this.authServiceRS = authServiceRS;\n            _this.bestaetigungFreigabequittung = false;\n            _this.isFreigebenClicked = false;\n            _this.showGesuchFreigebenSimulationButton = false;\n            _this.initViewModel();\n            return _this;\n        }\n        FreigabeViewController.prototype.initViewModel = function () {\n            this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus_1.TSWizardStepStatus.IN_BEARBEITUNG);\n            this.initDevModeParameter();\n            this.TSRoleUtil = TSRoleUtil_1.TSRoleUtil;\n        };\n        FreigabeViewController.prototype.gesuchEinreichen = function () {\n            this.isFreigebenClicked = true;\n            if (this.isGesuchValid() && this.bestaetigungFreigabequittung === true) {\n                this.form.$setPristine();\n                return this.DvDialog.showDialog(dialogTemplate, FreigabeDialogController_1.FreigabeDialogController, {\n                    parentController: this\n                });\n            }\n            return undefined;\n        };\n        FreigabeViewController.prototype.confirmationCallback = function () {\n            if (this.gesuchModelManager.isGesuch() || this.gesuchModelManager.areAllJAAngeboteNew()) {\n                this.openFreigabequittungPDF(true);\n            }\n            else {\n                this.gesuchFreigeben(); //wenn keine freigabequittung noetig direkt freigeben\n            }\n        };\n        FreigabeViewController.prototype.gesuchFreigeben = function () {\n            var gesuchID = this.gesuchModelManager.getGesuch().id;\n            this.gesuchModelManager.antragFreigeben(gesuchID, null);\n        };\n        FreigabeViewController.prototype.initDevModeParameter = function () {\n            var _this = this;\n            this.applicationPropertyRS.isDevMode().then(function (response) {\n                // Simulation nur fuer SuperAdmin freischalten\n                var isSuperadmin = _this.authServiceRS.isOneOfRoles(TSRoleUtil_1.TSRoleUtil.getAdministratorRoles());\n                // Die Simulation ist nur im Dev-Mode moeglich und nur, wenn das Gesuch im Status FREIGABEQUITTUNG ist\n                _this.showGesuchFreigebenSimulationButton = (response && _this.isGesuchInStatus(TSAntragStatus_1.TSAntragStatus.FREIGABEQUITTUNG) && isSuperadmin);\n            });\n        };\n        FreigabeViewController.prototype.isGesuchFreigegeben = function () {\n            if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().status) {\n                return TSAntragStatus_1.isAtLeastFreigegeben(this.gesuchModelManager.getGesuch().status)\n                    || (this.gesuchModelManager.getGesuch().status === TSAntragStatus_1.TSAntragStatus.FREIGABEQUITTUNG);\n            }\n            return false;\n        };\n        FreigabeViewController.prototype.isFreigabequittungAusstehend = function () {\n            if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().status) {\n                return this.gesuchModelManager.getGesuch().status === TSAntragStatus_1.TSAntragStatus.FREIGABEQUITTUNG;\n            }\n            return false;\n        };\n        FreigabeViewController.prototype.openFreigabequittungPDF = function (forceCreation) {\n            var _this = this;\n            var win = this.downloadRS.prepareDownloadWindow();\n            return this.downloadRS.getFreigabequittungAccessTokenGeneratedDokument(this.gesuchModelManager.getGesuch().id, forceCreation, this.getZustelladresse())\n                .then(function (downloadFile) {\n                // wir laden das Gesuch neu, da die Erstellung des Dokumentes auch Aenderungen im Gesuch verursacht\n                _this.gesuchModelManager.openGesuch(_this.gesuchModelManager.getGesuch().id)\n                    .then(function () {\n                    _this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n                })\n                    .catch(function (ex) {\n                    win.close();\n                });\n            });\n        };\n        FreigabeViewController.prototype.isThereAnySchulamtAngebot = function () {\n            return this.gesuchModelManager.isThereAnySchulamtAngebot();\n        };\n        FreigabeViewController.prototype.getFreigabeDatum = function () {\n            if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().freigabeDatum) {\n                return DateUtil_1.default.momentToLocalDateFormat(this.gesuchModelManager.getGesuch().freigabeDatum, 'DD.MM.YYYY');\n            }\n            return '';\n        };\n        FreigabeViewController.prototype.getTextForFreigebenNotAllowed = function () {\n            if (this.gesuchModelManager.getGesuch().gesperrtWegenBeschwerde) {\n                return 'FREIGABEQUITTUNG_NOT_ALLOWED_BESCHWERDE_TEXT';\n            }\n            else if (this.gesuchModelManager.isGesuchsperiodeReadonly()) {\n                return 'FREIGABEQUITTUNG_NOT_ALLOWED_GESUCHSPERIODE_TEXT';\n            }\n            else {\n                return 'FREIGABEQUITTUNG_NOT_ALLOWED_TEXT';\n            }\n        };\n        /**\n         * Die Methodes wizardStepManager.areAllStepsOK() erlaubt dass die Betreuungen in Status PLATZBESTAETIGUNG sind\n         * aber in diesem Fall duerfen diese nur OK sein, deswegen die Frage extra. Ausserdem darf es nur freigegebn werden\n         * wenn es nicht in ReadOnly modus ist\n         */\n        FreigabeViewController.prototype.canBeFreigegeben = function () {\n            return this.wizardStepManager.areAllStepsOK(this.gesuchModelManager.getGesuch()) &&\n                this.wizardStepManager.isStepStatusOk(TSWizardStepName_1.TSWizardStepName.BETREUUNG)\n                && !this.isGesuchReadonly() && this.isGesuchInStatus(TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_GS);\n        };\n        FreigabeViewController.prototype.isThereAnyAbgewieseneBetreuung = function () {\n            return this.gesuchModelManager.isThereAnyAbgewieseneBetreuung();\n        };\n        FreigabeViewController.prototype.getZustelladresse = function () {\n            if (this.gesuchModelManager.isGesuch()) {\n                if (this.gesuchModelManager.areThereOnlySchulamtAngebote()) {\n                    return TSZustelladresse_1.TSZustelladresse.SCHULAMT;\n                }\n                else {\n                    return TSZustelladresse_1.TSZustelladresse.JUGENDAMT;\n                }\n            }\n            else {\n                if (this.gesuchModelManager.areAllJAAngeboteNew()) {\n                    return TSZustelladresse_1.TSZustelladresse.JUGENDAMT;\n                }\n            }\n            return undefined;\n        };\n        /**\n         * Wir koennen auf jeden Fall sicher sein, dass alle Erstgesuche eine Freigabequittung haben.\n         * Ausserdem nur die Mutationen bei denen alle JA-Angebote neu sind, werden eine Freigabequittung haben\n         */\n        FreigabeViewController.prototype.isThereFreigabequittung = function () {\n            return this.gesuchModelManager.isGesuch() || this.gesuchModelManager.areAllJAAngeboteNew();\n        };\n        FreigabeViewController.prototype.$postLink = function () {\n            this.$timeout(function () {\n                EbeguUtil_1.default.selectFirst();\n            }, 100);\n        };\n        FreigabeViewController.$inject = ['GesuchModelManager', 'BerechnungsManager', 'WizardStepManager',\n            'DvDialog', 'DownloadRS', '$scope', 'ApplicationPropertyRS', 'AuthServiceRS', '$timeout'];\n        return FreigabeViewController;\n    }(abstractGesuchView_1.default));\n    exports.FreigabeViewController = FreigabeViewController;\n});\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/freigabeView/freigabeView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/freigabeView/freigabeView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport AbstractGesuchViewController from '../abstractGesuchView';\nimport {IComponentOptions, IPromise} from 'angular';\nimport GesuchModelManager from '../../service/gesuchModelManager';\nimport BerechnungsManager from '../../service/berechnungsManager';\nimport WizardStepManager from '../../service/wizardStepManager';\nimport {TSWizardStepName} from '../../../models/enums/TSWizardStepName';\nimport {TSWizardStepStatus} from '../../../models/enums/TSWizardStepStatus';\nimport {DvDialog} from '../../../core/directive/dv-dialog/dv-dialog';\nimport {DownloadRS} from '../../../core/service/downloadRS.rest';\nimport TSDownloadFile from '../../../models/TSDownloadFile';\nimport {isAtLeastFreigegeben, TSAntragStatus} from '../../../models/enums/TSAntragStatus';\nimport DateUtil from '../../../utils/DateUtil';\nimport {TSZustelladresse} from '../../../models/enums/TSZustelladresse';\nimport {ApplicationPropertyRS} from '../../../admin/service/applicationPropertyRS.rest';\nimport {FreigabeDialogController} from '../../dialog/FreigabeDialogController';\nimport AuthServiceRS from '../../../authentication/service/AuthServiceRS.rest';\nimport {TSRoleUtil} from '../../../utils/TSRoleUtil';\nimport EbeguUtil from '../../../utils/EbeguUtil';\nimport IScope = angular.IScope;\nimport ITimeoutService = angular.ITimeoutService;\n\nlet template = require('./freigabeView.html');\nrequire('./freigabeView.less');\nlet dialogTemplate = require('../../dialog/removeDialogTemplate.html');\n\nexport class FreigabeViewComponentConfig implements IComponentOptions {\n    transclude = false;\n    bindings: any = {};\n    template = template;\n    controller = FreigabeViewController;\n    controllerAs = 'vm';\n}\n\nexport class FreigabeViewController extends AbstractGesuchViewController<any> {\n\n    bestaetigungFreigabequittung: boolean = false;\n    isFreigebenClicked: boolean = false;\n    private showGesuchFreigebenSimulationButton: boolean = false;\n    TSRoleUtil: any;\n\n    static $inject = ['GesuchModelManager', 'BerechnungsManager', 'WizardStepManager',\n        'DvDialog', 'DownloadRS', '$scope', 'ApplicationPropertyRS', 'AuthServiceRS', '$timeout'];\n\n    /* @ngInject */\n    constructor(gesuchModelManager: GesuchModelManager, berechnungsManager: BerechnungsManager,\n                wizardStepManager: WizardStepManager, private DvDialog: DvDialog,\n                private downloadRS: DownloadRS, $scope: IScope, private applicationPropertyRS: ApplicationPropertyRS,\n                private authServiceRS: AuthServiceRS, $timeout: ITimeoutService) {\n\n        super(gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName.FREIGABE, $timeout);\n        this.initViewModel();\n    }\n\n    private initViewModel(): void {\n        this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus.IN_BEARBEITUNG);\n        this.initDevModeParameter();\n        this.TSRoleUtil = TSRoleUtil;\n    }\n\n    public gesuchEinreichen(): IPromise<void> {\n        this.isFreigebenClicked = true;\n        if (this.isGesuchValid() && this.bestaetigungFreigabequittung === true) {\n            this.form.$setPristine();\n            return this.DvDialog.showDialog(dialogTemplate, FreigabeDialogController, {\n                parentController: this\n            });\n        }\n        return undefined;\n    }\n\n    public confirmationCallback(): void {\n        if (this.gesuchModelManager.isGesuch() || this.gesuchModelManager.areAllJAAngeboteNew()) {\n            this.openFreigabequittungPDF(true);\n        } else {\n            this.gesuchFreigeben(); //wenn keine freigabequittung noetig direkt freigeben\n        }\n    }\n\n    public gesuchFreigeben(): void {\n        let gesuchID = this.gesuchModelManager.getGesuch().id;\n        this.gesuchModelManager.antragFreigeben(gesuchID, null);\n    }\n\n    private initDevModeParameter() {\n        this.applicationPropertyRS.isDevMode().then((response: boolean) => {\n            // Simulation nur fuer SuperAdmin freischalten\n            let isSuperadmin: boolean = this.authServiceRS.isOneOfRoles(TSRoleUtil.getAdministratorRoles());\n            // Die Simulation ist nur im Dev-Mode moeglich und nur, wenn das Gesuch im Status FREIGABEQUITTUNG ist\n            this.showGesuchFreigebenSimulationButton = (response && this.isGesuchInStatus(TSAntragStatus.FREIGABEQUITTUNG) && isSuperadmin);\n        });\n    }\n\n    public isGesuchFreigegeben(): boolean {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().status) {\n            return isAtLeastFreigegeben(this.gesuchModelManager.getGesuch().status)\n                || (this.gesuchModelManager.getGesuch().status === TSAntragStatus.FREIGABEQUITTUNG);\n        }\n        return false;\n    }\n\n    public isFreigabequittungAusstehend(): boolean {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().status) {\n            return this.gesuchModelManager.getGesuch().status === TSAntragStatus.FREIGABEQUITTUNG;\n        }\n        return false;\n    }\n\n    public openFreigabequittungPDF(forceCreation: boolean): IPromise<void> {\n        let win: Window = this.downloadRS.prepareDownloadWindow();\n        return this.downloadRS.getFreigabequittungAccessTokenGeneratedDokument(this.gesuchModelManager.getGesuch().id, forceCreation, this.getZustelladresse())\n            .then((downloadFile: TSDownloadFile) => {\n                // wir laden das Gesuch neu, da die Erstellung des Dokumentes auch Aenderungen im Gesuch verursacht\n                this.gesuchModelManager.openGesuch(this.gesuchModelManager.getGesuch().id)\n                    .then(() => {\n                        this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n                    })\n                    .catch((ex) => {\n                        win.close();\n                    });\n            });\n    }\n\n    public isThereAnySchulamtAngebot(): boolean {\n        return this.gesuchModelManager.isThereAnySchulamtAngebot();\n    }\n\n    public getFreigabeDatum(): string {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().freigabeDatum) {\n            return DateUtil.momentToLocalDateFormat(this.gesuchModelManager.getGesuch().freigabeDatum, 'DD.MM.YYYY');\n        }\n        return '';\n    }\n\n    public getTextForFreigebenNotAllowed(): string {\n        if (this.gesuchModelManager.getGesuch().gesperrtWegenBeschwerde) {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_BESCHWERDE_TEXT';\n        } else if (this.gesuchModelManager.isGesuchsperiodeReadonly()) {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_GESUCHSPERIODE_TEXT';\n        } else {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_TEXT';\n        }\n    }\n\n    /**\n     * Die Methodes wizardStepManager.areAllStepsOK() erlaubt dass die Betreuungen in Status PLATZBESTAETIGUNG sind\n     * aber in diesem Fall duerfen diese nur OK sein, deswegen die Frage extra. Ausserdem darf es nur freigegebn werden\n     * wenn es nicht in ReadOnly modus ist\n     */\n    public canBeFreigegeben(): boolean {\n        return this.wizardStepManager.areAllStepsOK(this.gesuchModelManager.getGesuch()) &&\n            this.wizardStepManager.isStepStatusOk(TSWizardStepName.BETREUUNG)\n            && !this.isGesuchReadonly() && this.isGesuchInStatus(TSAntragStatus.IN_BEARBEITUNG_GS);\n    }\n\n    public isThereAnyAbgewieseneBetreuung(): boolean {\n        return this.gesuchModelManager.isThereAnyAbgewieseneBetreuung();\n    }\n\n    private getZustelladresse(): TSZustelladresse {\n        if (this.gesuchModelManager.isGesuch()) {\n            if (this.gesuchModelManager.areThereOnlySchulamtAngebote()) {\n                return TSZustelladresse.SCHULAMT;\n            } else {\n                return TSZustelladresse.JUGENDAMT;\n            }\n\n        } else {\n            if (this.gesuchModelManager.areAllJAAngeboteNew()) {\n                return TSZustelladresse.JUGENDAMT;\n            }\n        }\n        return undefined;\n    }\n\n    /**\n     * Wir koennen auf jeden Fall sicher sein, dass alle Erstgesuche eine Freigabequittung haben.\n     * Ausserdem nur die Mutationen bei denen alle JA-Angebote neu sind, werden eine Freigabequittung haben\n     */\n    public isThereFreigabequittung(): boolean {\n        return this.gesuchModelManager.isGesuch() || this.gesuchModelManager.areAllJAAngeboteNew();\n    }\n\n    $postLink() {\n        this.$timeout(() => {\n            EbeguUtil.selectFirst();\n        }, 100);\n    }\n}\n"]}]}