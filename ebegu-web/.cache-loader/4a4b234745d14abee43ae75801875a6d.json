{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/freigabeView/freigabeView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/freigabeView/freigabeView.ts","mtime":1518612532802},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["\"use strict\";\n/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar abstractGesuchView_1 = require(\"../abstractGesuchView\");\nvar TSWizardStepName_1 = require(\"../../../models/enums/TSWizardStepName\");\nvar TSWizardStepStatus_1 = require(\"../../../models/enums/TSWizardStepStatus\");\nvar TSAntragStatus_1 = require(\"../../../models/enums/TSAntragStatus\");\nvar DateUtil_1 = require(\"../../../utils/DateUtil\");\nvar FreigabeDialogController_1 = require(\"../../dialog/FreigabeDialogController\");\nvar TSRoleUtil_1 = require(\"../../../utils/TSRoleUtil\");\nvar EbeguUtil_1 = require(\"../../../utils/EbeguUtil\");\nvar template = require('./freigabeView.html');\nrequire('./freigabeView.less');\nvar dialogTemplate = require('../../dialog/removeDialogTemplate.html');\nvar FreigabeViewComponentConfig = /** @class */ (function () {\n    function FreigabeViewComponentConfig() {\n        this.transclude = false;\n        this.bindings = {};\n        this.template = template;\n        this.controller = FreigabeViewController;\n        this.controllerAs = 'vm';\n    }\n    return FreigabeViewComponentConfig;\n}());\nexports.FreigabeViewComponentConfig = FreigabeViewComponentConfig;\nvar FreigabeViewController = /** @class */ (function (_super) {\n    __extends(FreigabeViewController, _super);\n    /* @ngInject */\n    function FreigabeViewController(gesuchModelManager, berechnungsManager, wizardStepManager, DvDialog, downloadRS, $scope, applicationPropertyRS, authServiceRS, $timeout) {\n        var _this = _super.call(this, gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName_1.TSWizardStepName.FREIGABE, $timeout) || this;\n        _this.DvDialog = DvDialog;\n        _this.downloadRS = downloadRS;\n        _this.applicationPropertyRS = applicationPropertyRS;\n        _this.authServiceRS = authServiceRS;\n        _this.bestaetigungFreigabequittung = false;\n        _this.isFreigebenClicked = false;\n        _this.showGesuchFreigebenSimulationButton = false;\n        _this.initViewModel();\n        return _this;\n    }\n    FreigabeViewController.prototype.initViewModel = function () {\n        this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus_1.TSWizardStepStatus.IN_BEARBEITUNG);\n        this.initDevModeParameter();\n        this.TSRoleUtil = TSRoleUtil_1.TSRoleUtil;\n    };\n    FreigabeViewController.prototype.gesuchEinreichen = function () {\n        this.isFreigebenClicked = true;\n        if (this.isGesuchValid() && this.bestaetigungFreigabequittung === true) {\n            this.form.$setPristine();\n            return this.DvDialog.showDialog(dialogTemplate, FreigabeDialogController_1.FreigabeDialogController, {\n                parentController: this\n            });\n        }\n        return undefined;\n    };\n    FreigabeViewController.prototype.confirmationCallback = function () {\n        if (this.gesuchModelManager.isGesuch()) {\n            this.openFreigabequittungPDF(true);\n        }\n        else {\n            this.gesuchFreigeben(); //wenn keine freigabequittung noetig direkt freigeben\n        }\n    };\n    FreigabeViewController.prototype.gesuchFreigeben = function () {\n        var gesuchID = this.gesuchModelManager.getGesuch().id;\n        this.gesuchModelManager.antragFreigeben(gesuchID, null, null);\n    };\n    FreigabeViewController.prototype.initDevModeParameter = function () {\n        var _this = this;\n        this.applicationPropertyRS.isDevMode().then(function (response) {\n            // Simulation nur fuer SuperAdmin freischalten\n            var isSuperadmin = _this.authServiceRS.isOneOfRoles(TSRoleUtil_1.TSRoleUtil.getAdministratorRoles());\n            // Die Simulation ist nur im Dev-Mode moeglich und nur, wenn das Gesuch im Status FREIGABEQUITTUNG ist\n            _this.showGesuchFreigebenSimulationButton = (response && _this.isGesuchInStatus(TSAntragStatus_1.TSAntragStatus.FREIGABEQUITTUNG) && isSuperadmin);\n        });\n    };\n    FreigabeViewController.prototype.isGesuchFreigegeben = function () {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().status) {\n            return TSAntragStatus_1.isAtLeastFreigegeben(this.gesuchModelManager.getGesuch().status)\n                || (this.gesuchModelManager.getGesuch().status === TSAntragStatus_1.TSAntragStatus.FREIGABEQUITTUNG);\n        }\n        return false;\n    };\n    FreigabeViewController.prototype.isFreigabequittungAusstehend = function () {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().status) {\n            return this.gesuchModelManager.getGesuch().status === TSAntragStatus_1.TSAntragStatus.FREIGABEQUITTUNG;\n        }\n        return false;\n    };\n    FreigabeViewController.prototype.openFreigabequittungPDF = function (forceCreation) {\n        var _this = this;\n        var win = this.downloadRS.prepareDownloadWindow();\n        return this.downloadRS.getFreigabequittungAccessTokenGeneratedDokument(this.gesuchModelManager.getGesuch().id, forceCreation)\n            .then(function (downloadFile) {\n            // wir laden das Gesuch neu, da die Erstellung des Dokumentes auch Aenderungen im Gesuch verursacht\n            _this.gesuchModelManager.openGesuch(_this.gesuchModelManager.getGesuch().id)\n                .then(function () {\n                _this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n            })\n                .catch(function (ex) {\n                win.close();\n            });\n        });\n    };\n    FreigabeViewController.prototype.isThereAnySchulamtAngebot = function () {\n        return this.gesuchModelManager.isThereAnySchulamtAngebot();\n    };\n    FreigabeViewController.prototype.getFreigabeDatum = function () {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().freigabeDatum) {\n            return DateUtil_1.default.momentToLocalDateFormat(this.gesuchModelManager.getGesuch().freigabeDatum, 'DD.MM.YYYY');\n        }\n        return '';\n    };\n    FreigabeViewController.prototype.getTextForFreigebenNotAllowed = function () {\n        if (this.gesuchModelManager.getGesuch().gesperrtWegenBeschwerde) {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_BESCHWERDE_TEXT';\n        }\n        else if (this.gesuchModelManager.isGesuchsperiodeReadonly()) {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_GESUCHSPERIODE_TEXT';\n        }\n        else {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_TEXT';\n        }\n    };\n    /**\n     * Die Methodes wizardStepManager.areAllStepsOK() erlaubt dass die Betreuungen in Status PLATZBESTAETIGUNG sind\n     * aber in diesem Fall duerfen diese nur OK sein, deswegen die Frage extra. Ausserdem darf es nur freigegebn werden\n     * wenn es nicht in ReadOnly modus ist\n     */\n    FreigabeViewController.prototype.canBeFreigegeben = function () {\n        return this.wizardStepManager.areAllStepsOK(this.gesuchModelManager.getGesuch()) &&\n            this.wizardStepManager.isStepStatusOk(TSWizardStepName_1.TSWizardStepName.BETREUUNG)\n            && !this.isGesuchReadonly() && this.isGesuchInStatus(TSAntragStatus_1.TSAntragStatus.IN_BEARBEITUNG_GS);\n    };\n    FreigabeViewController.prototype.isThereAnyAbgewieseneBetreuung = function () {\n        return this.gesuchModelManager.isThereAnyAbgewieseneBetreuung();\n    };\n    /**\n     * Wir koennen auf jeden Fall sicher sein, dass alle Erstgesuche eine Freigabequittung haben.\n     * Ausserdem nur die Mutationen bei denen alle JA-Angebote neu sind, werden eine Freigabequittung haben\n     */\n    FreigabeViewController.prototype.isThereFreigabequittung = function () {\n        return this.gesuchModelManager.isGesuch();\n    };\n    FreigabeViewController.prototype.$postLink = function () {\n        this.$timeout(function () {\n            EbeguUtil_1.default.selectFirst();\n        }, 100);\n    };\n    FreigabeViewController.$inject = ['GesuchModelManager', 'BerechnungsManager', 'WizardStepManager',\n        'DvDialog', 'DownloadRS', '$scope', 'ApplicationPropertyRS', 'AuthServiceRS', '$timeout'];\n    return FreigabeViewController;\n}(abstractGesuchView_1.default));\nexports.FreigabeViewController = FreigabeViewController;\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/freigabeView/freigabeView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/freigabeView/freigabeView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport AbstractGesuchViewController from '../abstractGesuchView';\nimport {IComponentOptions, IPromise} from 'angular';\nimport GesuchModelManager from '../../service/gesuchModelManager';\nimport BerechnungsManager from '../../service/berechnungsManager';\nimport WizardStepManager from '../../service/wizardStepManager';\nimport {TSWizardStepName} from '../../../models/enums/TSWizardStepName';\nimport {TSWizardStepStatus} from '../../../models/enums/TSWizardStepStatus';\nimport {DvDialog} from '../../../core/directive/dv-dialog/dv-dialog';\nimport {DownloadRS} from '../../../core/service/downloadRS.rest';\nimport TSDownloadFile from '../../../models/TSDownloadFile';\nimport {isAtLeastFreigegeben, TSAntragStatus} from '../../../models/enums/TSAntragStatus';\nimport DateUtil from '../../../utils/DateUtil';\nimport {ApplicationPropertyRS} from '../../../admin/service/applicationPropertyRS.rest';\nimport {FreigabeDialogController} from '../../dialog/FreigabeDialogController';\nimport AuthServiceRS from '../../../authentication/service/AuthServiceRS.rest';\nimport {TSRoleUtil} from '../../../utils/TSRoleUtil';\nimport EbeguUtil from '../../../utils/EbeguUtil';\nimport IScope = angular.IScope;\nimport ITimeoutService = angular.ITimeoutService;\n\nlet template = require('./freigabeView.html');\nrequire('./freigabeView.less');\nlet dialogTemplate = require('../../dialog/removeDialogTemplate.html');\n\nexport class FreigabeViewComponentConfig implements IComponentOptions {\n    transclude = false;\n    bindings: any = {};\n    template = template;\n    controller = FreigabeViewController;\n    controllerAs = 'vm';\n}\n\nexport class FreigabeViewController extends AbstractGesuchViewController<any> {\n\n    bestaetigungFreigabequittung: boolean = false;\n    isFreigebenClicked: boolean = false;\n    private showGesuchFreigebenSimulationButton: boolean = false;\n    TSRoleUtil: any;\n\n    static $inject = ['GesuchModelManager', 'BerechnungsManager', 'WizardStepManager',\n        'DvDialog', 'DownloadRS', '$scope', 'ApplicationPropertyRS', 'AuthServiceRS', '$timeout'];\n\n    /* @ngInject */\n    constructor(gesuchModelManager: GesuchModelManager, berechnungsManager: BerechnungsManager,\n                wizardStepManager: WizardStepManager, private DvDialog: DvDialog,\n                private downloadRS: DownloadRS, $scope: IScope, private applicationPropertyRS: ApplicationPropertyRS,\n                private authServiceRS: AuthServiceRS, $timeout: ITimeoutService) {\n\n        super(gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName.FREIGABE, $timeout);\n        this.initViewModel();\n    }\n\n    private initViewModel(): void {\n        this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus.IN_BEARBEITUNG);\n        this.initDevModeParameter();\n        this.TSRoleUtil = TSRoleUtil;\n    }\n\n    public gesuchEinreichen(): IPromise<void> {\n        this.isFreigebenClicked = true;\n        if (this.isGesuchValid() && this.bestaetigungFreigabequittung === true) {\n            this.form.$setPristine();\n            return this.DvDialog.showDialog(dialogTemplate, FreigabeDialogController, {\n                parentController: this\n            });\n        }\n        return undefined;\n    }\n\n    public confirmationCallback(): void {\n        if (this.gesuchModelManager.isGesuch()) {\n            this.openFreigabequittungPDF(true);\n        } else {\n            this.gesuchFreigeben(); //wenn keine freigabequittung noetig direkt freigeben\n        }\n    }\n\n    public gesuchFreigeben(): void {\n        let gesuchID = this.gesuchModelManager.getGesuch().id;\n        this.gesuchModelManager.antragFreigeben(gesuchID, null, null);\n    }\n\n    private initDevModeParameter() {\n        this.applicationPropertyRS.isDevMode().then((response: boolean) => {\n            // Simulation nur fuer SuperAdmin freischalten\n            let isSuperadmin: boolean = this.authServiceRS.isOneOfRoles(TSRoleUtil.getAdministratorRoles());\n            // Die Simulation ist nur im Dev-Mode moeglich und nur, wenn das Gesuch im Status FREIGABEQUITTUNG ist\n            this.showGesuchFreigebenSimulationButton = (response && this.isGesuchInStatus(TSAntragStatus.FREIGABEQUITTUNG) && isSuperadmin);\n        });\n    }\n\n    public isGesuchFreigegeben(): boolean {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().status) {\n            return isAtLeastFreigegeben(this.gesuchModelManager.getGesuch().status)\n                || (this.gesuchModelManager.getGesuch().status === TSAntragStatus.FREIGABEQUITTUNG);\n        }\n        return false;\n    }\n\n    public isFreigabequittungAusstehend(): boolean {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().status) {\n            return this.gesuchModelManager.getGesuch().status === TSAntragStatus.FREIGABEQUITTUNG;\n        }\n        return false;\n    }\n\n    public openFreigabequittungPDF(forceCreation: boolean): IPromise<void> {\n        let win: Window = this.downloadRS.prepareDownloadWindow();\n        return this.downloadRS.getFreigabequittungAccessTokenGeneratedDokument(this.gesuchModelManager.getGesuch().id, forceCreation)\n            .then((downloadFile: TSDownloadFile) => {\n                // wir laden das Gesuch neu, da die Erstellung des Dokumentes auch Aenderungen im Gesuch verursacht\n                this.gesuchModelManager.openGesuch(this.gesuchModelManager.getGesuch().id)\n                    .then(() => {\n                        this.downloadRS.startDownload(downloadFile.accessToken, downloadFile.filename, false, win);\n                    })\n                    .catch((ex) => {\n                        win.close();\n                    });\n            });\n    }\n\n    public isThereAnySchulamtAngebot(): boolean {\n        return this.gesuchModelManager.isThereAnySchulamtAngebot();\n    }\n\n    public getFreigabeDatum(): string {\n        if (this.gesuchModelManager.getGesuch() && this.gesuchModelManager.getGesuch().freigabeDatum) {\n            return DateUtil.momentToLocalDateFormat(this.gesuchModelManager.getGesuch().freigabeDatum, 'DD.MM.YYYY');\n        }\n        return '';\n    }\n\n    public getTextForFreigebenNotAllowed(): string {\n        if (this.gesuchModelManager.getGesuch().gesperrtWegenBeschwerde) {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_BESCHWERDE_TEXT';\n        } else if (this.gesuchModelManager.isGesuchsperiodeReadonly()) {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_GESUCHSPERIODE_TEXT';\n        } else {\n            return 'FREIGABEQUITTUNG_NOT_ALLOWED_TEXT';\n        }\n    }\n\n    /**\n     * Die Methodes wizardStepManager.areAllStepsOK() erlaubt dass die Betreuungen in Status PLATZBESTAETIGUNG sind\n     * aber in diesem Fall duerfen diese nur OK sein, deswegen die Frage extra. Ausserdem darf es nur freigegebn werden\n     * wenn es nicht in ReadOnly modus ist\n     */\n    public canBeFreigegeben(): boolean {\n        return this.wizardStepManager.areAllStepsOK(this.gesuchModelManager.getGesuch()) &&\n            this.wizardStepManager.isStepStatusOk(TSWizardStepName.BETREUUNG)\n            && !this.isGesuchReadonly() && this.isGesuchInStatus(TSAntragStatus.IN_BEARBEITUNG_GS);\n    }\n\n    public isThereAnyAbgewieseneBetreuung(): boolean {\n        return this.gesuchModelManager.isThereAnyAbgewieseneBetreuung();\n    }\n\n    /**\n     * Wir koennen auf jeden Fall sicher sein, dass alle Erstgesuche eine Freigabequittung haben.\n     * Ausserdem nur die Mutationen bei denen alle JA-Angebote neu sind, werden eine Freigabequittung haben\n     */\n    public isThereFreigabequittung(): boolean {\n        return this.gesuchModelManager.isGesuch();\n    }\n\n    $postLink() {\n        this.$timeout(() => {\n            EbeguUtil.selectFirst();\n        }, 100);\n    }\n}\n"]}]}