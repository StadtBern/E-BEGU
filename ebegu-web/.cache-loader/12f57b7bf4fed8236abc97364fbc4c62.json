{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/admin/component/institutionView/institutionView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/admin/component/institutionView/institutionView.ts","mtime":1518535855204},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\ndefine([\"require\", \"exports\", \"../../../models/TSInstitution\", \"../../../models/TSInstitutionStammdaten\", \"../../../models/TSAdresse\", \"../../../models/enums/TSBetreuungsangebotTyp\", \"../../../utils/EbeguUtil\", \"../../../gesuch/dialog/OkDialogController\", \"../../../gesuch/dialog/RemoveDialogController\", \"../../../gesuch/dialog/OkHtmlDialogController\", \"../../abstractAdminView\", \"./institutionView.less\"], function (require, exports, TSInstitution_1, TSInstitutionStammdaten_1, TSAdresse_1, TSBetreuungsangebotTyp_1, EbeguUtil_1, OkDialogController_1, RemoveDialogController_1, OkHtmlDialogController_1, abstractAdminView_1) {\n    \"use strict\";\n    Object.defineProperty(exports, \"__esModule\", { value: true });\n    var template = require('./institutionView.html');\n    var style = require('./institutionView.less');\n    var removeDialogTemplate = require('../../../gesuch/dialog/removeDialogTemplate.html');\n    var okDialogTempl = require('../../../gesuch/dialog/okDialogTemplate.html');\n    var okHtmlDialogTempl = require('../../../gesuch/dialog/okHtmlDialogTemplate.html');\n    var InstitutionViewComponentConfig = /** @class */ (function () {\n        function InstitutionViewComponentConfig() {\n            this.transclude = false;\n            this.bindings = {\n                institutionen: '<',\n                traegerschaften: '<',\n                mandant: '<'\n            };\n            this.template = template;\n            this.controller = InstitutionViewController;\n            this.controllerAs = 'vm';\n        }\n        return InstitutionViewComponentConfig;\n    }());\n    exports.InstitutionViewComponentConfig = InstitutionViewComponentConfig;\n    var InstitutionViewController = /** @class */ (function (_super) {\n        __extends(InstitutionViewController, _super);\n        /* @ngInject */\n        function InstitutionViewController(institutionRS, ebeguUtil, institutionStammdatenRS, errorService, dvDialog, listResourceRS, authServiceRS) {\n            var _this = _super.call(this, authServiceRS) || this;\n            _this.errorService = errorService;\n            _this.dvDialog = dvDialog;\n            _this.instStammdatenList = [];\n            _this.selectedInstitution = null;\n            _this.isSelected = false;\n            _this.selectedInstitutionStammdaten = null;\n            _this.isSelectedStammdaten = false;\n            _this.selectedInstitutionStammdatenBetreuungsangebot = null;\n            _this.errormessage = undefined;\n            _this.hasDifferentZahlungsadresse = false;\n            _this.institutionRS = institutionRS;\n            _this.ebeguUtil = ebeguUtil;\n            _this.institutionStammdatenRS = institutionStammdatenRS;\n            _this.setBetreuungsangebotTypValues();\n            listResourceRS.getLaenderList().then(function (laenderList) {\n                _this.laenderList = laenderList;\n            });\n            return _this;\n        }\n        InstitutionViewController.prototype.getInstitutionenList = function () {\n            return this.institutionen;\n        };\n        InstitutionViewController.prototype.getTreagerschaftList = function () {\n            return this.traegerschaften;\n        };\n        InstitutionViewController.prototype.setSelectedInstitution = function (institution) {\n            var _this = this;\n            this.selectedInstitution = institution;\n            this.isSelected = true;\n            this.selectedInstitutionStammdaten = null;\n            this.isSelectedStammdaten = false;\n            this.institutionStammdatenRS.getAllInstitutionStammdatenByInstitution(this.selectedInstitution.id).then(function (loadedInstStammdaten) {\n                _this.instStammdatenList = loadedInstStammdaten;\n            });\n            this.errormessage = undefined;\n        };\n        InstitutionViewController.prototype.isCreateInstitutionsMode = function () {\n            return this.selectedInstitution.isNew();\n        };\n        InstitutionViewController.prototype.isCreateStammdatenMode = function () {\n            return this.selectedInstitutionStammdaten.isNew();\n        };\n        InstitutionViewController.prototype.getSelectedInstitution = function () {\n            return this.selectedInstitution;\n        };\n        InstitutionViewController.prototype.isSelectedInstitution = function () {\n            return this.isSelected;\n        };\n        InstitutionViewController.prototype.removeInstitution = function (institution) {\n            var _this = this;\n            this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController_1.RemoveDialogController, {\n                deleteText: '',\n                title: 'LOESCHEN_DIALOG_TITLE',\n                parentController: undefined,\n                elementID: undefined\n            })\n                .then(function () {\n                _this.selectedInstitution = null;\n                _this.isSelected = false;\n                _this.institutionRS.removeInstitution(institution.id).then(function (response) {\n                    var index = EbeguUtil_1.default.getIndexOfElementwithID(institution, _this.institutionen);\n                    if (index > -1) {\n                        _this.institutionen.splice(index, 1);\n                    }\n                });\n            });\n        };\n        InstitutionViewController.prototype.createInstitution = function () {\n            this.selectedInstitution = new TSInstitution_1.default();\n            this.selectedInstitution.mandant = this.mandant;\n            this.isSelected = true;\n            this.selectedInstitutionStammdaten = null;\n            this.isSelectedStammdaten = false;\n            this.instStammdatenList = [];\n        };\n        InstitutionViewController.prototype.saveInstitution = function (form) {\n            var _this = this;\n            if (form.$valid) {\n                this.errorService.clearAll();\n                if (this.isCreateInstitutionsMode() === true) {\n                    this.institutionRS.createInstitution(this.selectedInstitution).then(function (institution) {\n                        _this.institutionen.push(institution);\n                        _this.resetInstitutionSelection();\n                        if (!institution.synchronizedWithOpenIdm) {\n                            _this.dvDialog.showDialog(okDialogTempl, OkDialogController_1.OkDialogController, {\n                                title: 'INSTITUTION_CREATE_SYNCHRONIZE'\n                            });\n                        }\n                    });\n                }\n                else {\n                    this.institutionRS.updateInstitution(this.selectedInstitution).then(function (institution) {\n                        var index = EbeguUtil_1.default.getIndexOfElementwithID(institution, _this.institutionen);\n                        if (index > -1) {\n                            _this.institutionen[index] = institution;\n                            _this.resetInstitutionSelection();\n                            if (!institution.synchronizedWithOpenIdm) {\n                                _this.dvDialog.showDialog(okDialogTempl, OkDialogController_1.OkDialogController, {\n                                    title: 'INSTITUTION_UPDATE_SYNCHRONIZE'\n                                });\n                            }\n                        }\n                    });\n                }\n            }\n        };\n        InstitutionViewController.prototype.resetInstitutionSelection = function () {\n            this.selectedInstitution = null;\n            this.isSelected = false;\n            this.errormessage = undefined;\n        };\n        InstitutionViewController.prototype.getSelectedInstitutionStammdatenList = function () {\n            return this.instStammdatenList;\n        };\n        InstitutionViewController.prototype.setSelectedInstitutionStammdaten = function (institutionStammdaten) {\n            this.selectedInstitutionStammdaten = institutionStammdaten;\n            this.selectedInstitutionStammdatenBetreuungsangebot = this.getBetreuungsangebotFromInstitutionList(institutionStammdaten.betreuungsangebotTyp);\n            this.isSelectedStammdaten = true;\n            this.hasDifferentZahlungsadresse = !!this.selectedInstitutionStammdaten.adresseKontoinhaber;\n        };\n        InstitutionViewController.prototype.getSelectedInstitutionStammdaten = function () {\n            return this.selectedInstitutionStammdaten;\n        };\n        InstitutionViewController.prototype.isSelectedInstitutionStammdaten = function () {\n            return this.isSelectedStammdaten;\n        };\n        InstitutionViewController.prototype.createInstitutionStammdaten = function () {\n            this.selectedInstitutionStammdaten = new TSInstitutionStammdaten_1.default();\n            this.selectedInstitutionStammdaten.adresse = new TSAdresse_1.default();\n            this.selectedInstitutionStammdaten.institution = this.selectedInstitution;\n            this.isSelectedStammdaten = true;\n        };\n        InstitutionViewController.prototype.differentZahlungsadresseClicked = function () {\n            if (this.hasDifferentZahlungsadresse) {\n                this.selectedInstitutionStammdaten.adresseKontoinhaber = new TSAdresse_1.default();\n            }\n            else {\n                this.selectedInstitutionStammdaten.adresseKontoinhaber = undefined;\n            }\n        };\n        InstitutionViewController.prototype.saveInstitutionStammdaten = function (form) {\n            var _this = this;\n            if (form.$valid) {\n                this.selectedInstitutionStammdaten.betreuungsangebotTyp = this.selectedInstitutionStammdatenBetreuungsangebot.key;\n                this.errorService.clearAll();\n                if (this.isCreateStammdatenMode()) {\n                    this.institutionStammdatenRS.createInstitutionStammdaten(this.selectedInstitutionStammdaten).then(function (institutionStammdaten) {\n                        _this.instStammdatenList.push(institutionStammdaten);\n                        _this.resetInstitutionStammdatenSelection();\n                    });\n                }\n                else {\n                    this.institutionStammdatenRS.updateInstitutionStammdaten(this.selectedInstitutionStammdaten).then(function (institutionStammdaten) {\n                        var index = EbeguUtil_1.default.getIndexOfElementwithID(institutionStammdaten, _this.instStammdatenList);\n                        if (index > -1) {\n                            _this.instStammdatenList[index] = institutionStammdaten;\n                            _this.resetInstitutionStammdatenSelection();\n                        }\n                    });\n                }\n            }\n        };\n        InstitutionViewController.prototype.resetInstitutionStammdatenSelection = function () {\n            this.selectedInstitutionStammdaten = null;\n            this.isSelectedStammdaten = false;\n        };\n        InstitutionViewController.prototype.removeInstitutionStammdaten = function (institutionStammdaten) {\n            var _this = this;\n            this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController_1.RemoveDialogController, {\n                deleteText: '',\n                title: 'LOESCHEN_DIALOG_TITLE',\n                parentController: undefined,\n                elementID: undefined\n            })\n                .then(function () {\n                _this.institutionStammdatenRS.removeInstitutionStammdaten(institutionStammdaten.id).then(function (result) {\n                    var index = EbeguUtil_1.default.getIndexOfElementwithID(institutionStammdaten, _this.instStammdatenList);\n                    if (index > -1) {\n                        _this.instStammdatenList.splice(index, 1);\n                    }\n                    _this.isSelectedStammdaten = false;\n                }).catch(function (ex) {\n                    _this.errormessage = 'INSTITUTION_STAMMDATEN_DELETE_FAILED';\n                });\n            });\n        };\n        InstitutionViewController.prototype.setBetreuungsangebotTypValues = function () {\n            this.betreuungsangebotValues = this.ebeguUtil.translateStringList(TSBetreuungsangebotTyp_1.getTSBetreuungsangebotTypValues());\n        };\n        InstitutionViewController.prototype.getBetreuungsangebotFromInstitutionList = function (betreuungsangebotTyp) {\n            return $.grep(this.betreuungsangebotValues, function (value) {\n                return value.key === betreuungsangebotTyp;\n            })[0];\n        };\n        InstitutionViewController.prototype.isKita = function () {\n            if (this.selectedInstitutionStammdatenBetreuungsangebot && this.selectedInstitutionStammdatenBetreuungsangebot.key === TSBetreuungsangebotTyp_1.TSBetreuungsangebotTyp.KITA) {\n                return true;\n            }\n            else {\n                return false;\n            }\n        };\n        InstitutionViewController.prototype.getDateString = function (dateRange, format) {\n            if (dateRange.gueltigAb) {\n                if (!dateRange.gueltigBis) {\n                    return dateRange.gueltigAb.format(format);\n                }\n                else {\n                    return dateRange.gueltigAb.format(format) + ' - ' + dateRange.gueltigBis.format(format);\n                }\n            }\n            return '';\n        };\n        InstitutionViewController.prototype.syncWithOpenIdm = function () {\n            var _this = this;\n            this.institutionRS.synchronizeInstitutions().then(function (respone) {\n                var returnString = respone.data.replace(/(?:\\r\\n|\\r|\\n)/g, '<br />');\n                return _this.dvDialog.showDialog(okHtmlDialogTempl, OkHtmlDialogController_1.OkHtmlDialogController, {\n                    title: returnString\n                }).then(function () {\n                    //do nothing\n                });\n            });\n        };\n        InstitutionViewController.$inject = ['InstitutionRS', 'EbeguUtil', 'InstitutionStammdatenRS', 'ErrorService', 'DvDialog', 'ListResourceRS', 'AuthServiceRS'];\n        return InstitutionViewController;\n    }(abstractAdminView_1.default));\n    exports.InstitutionViewController = InstitutionViewController;\n});\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/admin/component/institutionView/institutionView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/admin/component/institutionView/institutionView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {IComponentOptions} from 'angular';\nimport './institutionView.less';\nimport TSInstitution from '../../../models/TSInstitution';\nimport TSInstitutionStammdaten from '../../../models/TSInstitutionStammdaten';\nimport {InstitutionRS} from '../../../core/service/institutionRS.rest';\nimport {InstitutionStammdatenRS} from '../../../core/service/institutionStammdatenRS.rest';\nimport {TSTraegerschaft} from '../../../models/TSTraegerschaft';\nimport {TSMandant} from '../../../models/TSMandant';\nimport TSAdresse from '../../../models/TSAdresse';\nimport {getTSBetreuungsangebotTypValues, TSBetreuungsangebotTyp} from '../../../models/enums/TSBetreuungsangebotTyp';\nimport EbeguUtil from '../../../utils/EbeguUtil';\nimport ErrorService from '../../../core/errors/service/ErrorService';\nimport {TSDateRange} from '../../../models/types/TSDateRange';\nimport {OkDialogController} from '../../../gesuch/dialog/OkDialogController';\nimport {DvDialog} from '../../../core/directive/dv-dialog/dv-dialog';\nimport {RemoveDialogController} from '../../../gesuch/dialog/RemoveDialogController';\nimport {OkHtmlDialogController} from '../../../gesuch/dialog/OkHtmlDialogController';\nimport ListResourceRS from '../../../core/service/listResourceRS.rest';\nimport TSLand from '../../../models/types/TSLand';\nimport AbstractAdminViewController from '../../abstractAdminView';\nimport AuthServiceRS from '../../../authentication/service/AuthServiceRS.rest';\nimport IFormController = angular.IFormController;\nlet template = require('./institutionView.html');\nlet style = require('./institutionView.less');\nlet removeDialogTemplate = require('../../../gesuch/dialog/removeDialogTemplate.html');\nlet okDialogTempl = require('../../../gesuch/dialog/okDialogTemplate.html');\nlet okHtmlDialogTempl = require('../../../gesuch/dialog/okHtmlDialogTemplate.html');\n\nexport class InstitutionViewComponentConfig implements IComponentOptions {\n    transclude: boolean = false;\n    bindings: any = {\n        institutionen: '<',\n        traegerschaften: '<',\n        mandant: '<'\n    };\n    template: string = template;\n    controller: any = InstitutionViewController;\n    controllerAs: string = 'vm';\n}\n\nexport class InstitutionViewController extends AbstractAdminViewController {\n\n    institutionRS: InstitutionRS;\n    institutionStammdatenRS: InstitutionStammdatenRS;\n    ebeguUtil: EbeguUtil;\n    institutionen: TSInstitution[];\n    traegerschaften: TSTraegerschaft[];\n    mandant: TSMandant;\n    instStammdatenList: TSInstitutionStammdaten[] = [];\n    selectedInstitution: TSInstitution = null;\n    isSelected: boolean = false;\n    selectedInstitutionStammdaten: TSInstitutionStammdaten = null;\n    isSelectedStammdaten: boolean = false;\n    betreuungsangebotValues: Array<any>;\n    selectedInstitutionStammdatenBetreuungsangebot: any = null;\n    laenderList: TSLand[];\n    errormessage: string = undefined;\n    hasDifferentZahlungsadresse: boolean = false;\n\n\n    static $inject = ['InstitutionRS', 'EbeguUtil', 'InstitutionStammdatenRS', 'ErrorService', 'DvDialog', 'ListResourceRS', 'AuthServiceRS'];\n    /* @ngInject */\n    constructor(institutionRS: InstitutionRS, ebeguUtil: EbeguUtil, institutionStammdatenRS: InstitutionStammdatenRS,\n                private errorService: ErrorService, private dvDialog: DvDialog, listResourceRS: ListResourceRS, authServiceRS: AuthServiceRS) {\n        super(authServiceRS);\n        this.institutionRS = institutionRS;\n        this.ebeguUtil = ebeguUtil;\n        this.institutionStammdatenRS = institutionStammdatenRS;\n        this.setBetreuungsangebotTypValues();\n        listResourceRS.getLaenderList().then((laenderList: TSLand[]) => {\n            this.laenderList = laenderList;\n        });\n\n    }\n\n    getInstitutionenList(): TSInstitution[] {\n        return this.institutionen;\n    }\n\n    getTreagerschaftList(): Array<TSTraegerschaft> {\n        return this.traegerschaften;\n    }\n\n    setSelectedInstitution(institution: TSInstitution): void {\n        this.selectedInstitution = institution;\n        this.isSelected = true;\n        this.selectedInstitutionStammdaten = null;\n        this.isSelectedStammdaten = false;\n        this.institutionStammdatenRS.getAllInstitutionStammdatenByInstitution(this.selectedInstitution.id).then((loadedInstStammdaten) => {\n            this.instStammdatenList = loadedInstStammdaten;\n        });\n        this.errormessage = undefined;\n    }\n\n    isCreateInstitutionsMode(): boolean {\n        return this.selectedInstitution.isNew();\n\n    }\n\n    isCreateStammdatenMode(): boolean {\n        return this.selectedInstitutionStammdaten.isNew();\n    }\n\n    getSelectedInstitution(): TSInstitution {\n        return this.selectedInstitution;\n    }\n\n    isSelectedInstitution(): boolean {\n        return this.isSelected;\n    }\n\n    removeInstitution(institution: any): void {\n        this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController, {\n            deleteText: '',\n            title: 'LOESCHEN_DIALOG_TITLE',\n            parentController: undefined,\n            elementID: undefined\n        })\n        .then(() => {   //User confirmed removal\n            this.selectedInstitution = null;\n            this.isSelected = false;\n            this.institutionRS.removeInstitution(institution.id).then((response) => {\n                let index = EbeguUtil.getIndexOfElementwithID(institution, this.institutionen);\n                if (index > -1) {\n                    this.institutionen.splice(index, 1);\n                }\n            });\n        });\n\n    }\n\n    createInstitution(): void {\n        this.selectedInstitution = new TSInstitution();\n        this.selectedInstitution.mandant = this.mandant;\n        this.isSelected = true;\n        this.selectedInstitutionStammdaten = null;\n        this.isSelectedStammdaten = false;\n        this.instStammdatenList = [];\n    }\n\n    saveInstitution(form: IFormController): void {\n        if (form.$valid) {\n            this.errorService.clearAll();\n            if (this.isCreateInstitutionsMode() === true) {\n                this.institutionRS.createInstitution(this.selectedInstitution).then((institution: TSInstitution) => {\n                    this.institutionen.push(institution);\n                    this.resetInstitutionSelection();\n                    if (!institution.synchronizedWithOpenIdm) {\n                        this.dvDialog.showDialog(okDialogTempl, OkDialogController, {\n                            title: 'INSTITUTION_CREATE_SYNCHRONIZE'\n                        });\n                    }\n                });\n            } else {\n                this.institutionRS.updateInstitution(this.selectedInstitution).then((institution: TSInstitution) => {\n                    let index = EbeguUtil.getIndexOfElementwithID(institution, this.institutionen);\n                    if (index > -1) {\n                        this.institutionen[index] = institution;\n                        this.resetInstitutionSelection();\n                        if (!institution.synchronizedWithOpenIdm) {\n                            this.dvDialog.showDialog(okDialogTempl, OkDialogController, {\n                                title: 'INSTITUTION_UPDATE_SYNCHRONIZE'\n                            });\n                        }\n                    }\n                });\n            }\n        }\n\n    }\n\n    private resetInstitutionSelection() {\n        this.selectedInstitution = null;\n        this.isSelected = false;\n        this.errormessage = undefined;\n    }\n\n    getSelectedInstitutionStammdatenList(): TSInstitutionStammdaten[] {\n        return this.instStammdatenList;\n    }\n\n    setSelectedInstitutionStammdaten(institutionStammdaten: any): void {\n        this.selectedInstitutionStammdaten = institutionStammdaten;\n        this.selectedInstitutionStammdatenBetreuungsangebot = this.getBetreuungsangebotFromInstitutionList(institutionStammdaten.betreuungsangebotTyp);\n        this.isSelectedStammdaten = true;\n        this.hasDifferentZahlungsadresse = !!this.selectedInstitutionStammdaten.adresseKontoinhaber;\n    }\n\n    getSelectedInstitutionStammdaten(): TSInstitutionStammdaten {\n        return this.selectedInstitutionStammdaten;\n    }\n\n    isSelectedInstitutionStammdaten(): boolean {\n        return this.isSelectedStammdaten;\n    }\n\n    createInstitutionStammdaten(): void {\n        this.selectedInstitutionStammdaten = new TSInstitutionStammdaten();\n        this.selectedInstitutionStammdaten.adresse = new TSAdresse();\n        this.selectedInstitutionStammdaten.institution = this.selectedInstitution;\n        this.isSelectedStammdaten = true;\n    }\n\n    differentZahlungsadresseClicked(): void {\n        if (this.hasDifferentZahlungsadresse) {\n            this.selectedInstitutionStammdaten.adresseKontoinhaber = new TSAdresse();\n        } else {\n            this.selectedInstitutionStammdaten.adresseKontoinhaber = undefined;\n        }\n    }\n\n    saveInstitutionStammdaten(form: IFormController): void {\n        if (form.$valid) {\n            this.selectedInstitutionStammdaten.betreuungsangebotTyp = this.selectedInstitutionStammdatenBetreuungsangebot.key;\n            this.errorService.clearAll();\n            if (this.isCreateStammdatenMode()) {\n                this.institutionStammdatenRS.createInstitutionStammdaten(this.selectedInstitutionStammdaten).then((institutionStammdaten: TSInstitutionStammdaten) => {\n                    this.instStammdatenList.push(institutionStammdaten);\n                    this.resetInstitutionStammdatenSelection();\n                });\n            } else {\n                this.institutionStammdatenRS.updateInstitutionStammdaten(this.selectedInstitutionStammdaten).then((institutionStammdaten: TSInstitutionStammdaten) => {\n                    let index = EbeguUtil.getIndexOfElementwithID(institutionStammdaten, this.instStammdatenList);\n                    if (index > -1) {\n                        this.instStammdatenList[index] = institutionStammdaten;\n                        this.resetInstitutionStammdatenSelection();\n                    }\n                });\n            }\n        }\n    }\n\n    private resetInstitutionStammdatenSelection() {\n        this.selectedInstitutionStammdaten = null;\n        this.isSelectedStammdaten = false;\n    }\n\n    removeInstitutionStammdaten(institutionStammdaten: TSInstitutionStammdaten): void {\n        this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController, {\n            deleteText: '',\n            title: 'LOESCHEN_DIALOG_TITLE',\n            parentController: undefined,\n            elementID: undefined\n        })\n        .then(() => {   //User confirmed removal\n            this.institutionStammdatenRS.removeInstitutionStammdaten(institutionStammdaten.id).then((result) => {\n                let index = EbeguUtil.getIndexOfElementwithID(institutionStammdaten, this.instStammdatenList);\n                if (index > -1) {\n                    this.instStammdatenList.splice(index, 1);\n                }\n                this.isSelectedStammdaten = false;\n            }).catch((ex) => {\n                this.errormessage = 'INSTITUTION_STAMMDATEN_DELETE_FAILED';\n            });\n        });\n\n    }\n\n    private setBetreuungsangebotTypValues(): void {\n        this.betreuungsangebotValues = this.ebeguUtil.translateStringList(getTSBetreuungsangebotTypValues());\n    }\n\n    getBetreuungsangebotFromInstitutionList(betreuungsangebotTyp: TSBetreuungsangebotTyp) {\n        return $.grep(this.betreuungsangebotValues, (value: any) => {\n            return value.key === betreuungsangebotTyp;\n        })[0];\n    }\n\n    isKita(): boolean {\n        if (this.selectedInstitutionStammdatenBetreuungsangebot && this.selectedInstitutionStammdatenBetreuungsangebot.key === TSBetreuungsangebotTyp.KITA) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n    getDateString(dateRange: TSDateRange, format: string): string {\n        if (dateRange.gueltigAb) {\n            if (!dateRange.gueltigBis) {\n                return dateRange.gueltigAb.format(format);\n            } else {\n                return dateRange.gueltigAb.format(format) + ' - ' + dateRange.gueltigBis.format(format);\n            }\n        }\n        return '';\n    }\n\n    private syncWithOpenIdm(): void {\n        this.institutionRS.synchronizeInstitutions().then((respone) => {\n            let returnString = respone.data.replace(/(?:\\r\\n|\\r|\\n)/g, '<br />');\n            return this.dvDialog.showDialog(okHtmlDialogTempl, OkHtmlDialogController, {\n                title: returnString\n            }).then(() => {\n                //do nothing\n            });\n        });\n    }\n\n}\n"]}]}